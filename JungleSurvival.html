<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>無邊界叢林生存 v22.1 (恐龍紀元)</title>
    <style>
        html, body { margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; background-color: #000; }
        body { font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; color: #f0f0f0; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #top-left-ui { position: absolute; top: 10px; left: 50px; display: flex; align-items: flex-start; gap: 10px; }
        .status-bar, #pet-status-bar { background-color: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 5px; font-size: 14px; white-space: nowrap; }
        .status-bar { pointer-events: auto; cursor: pointer; }
        #pet-status-bar { display: none; pointer-events: auto; cursor: pointer; }
        #time-display { position: absolute; top: 10px; right: 50px; background-color: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 5px; font-size: 16px; }
        .top-left-buttons { position: absolute; top: 10px; left: 10px; display: flex; gap: 10px; pointer-events: auto; }
        .ui-button { width: 30px; height: 30px; background-color: rgba(100,100,100,0.7); border-radius: 5px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 20px; font-weight: bold; color: white; pointer-events: auto; }
        #inventory { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; display: flex; gap: 10px; pointer-events: auto; max-width: 90vw; overflow-x: auto; }
        .inventory-item { position: relative; width: 50px; height: 50px; border: 2px solid #888; background-color: #333; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
        .inventory-item.selected { border-color: #FFEB3B; transform: scale(1.1); box-shadow: 0 0 10px #FFEB3B; }
        .item-name { font-size: 12px; position: absolute; top: 3px; text-align: center; width: 100%; line-height: 1; }
        .item-name.icon-style { font-size: 28px; top: 50%; transform: translateY(-50%); }
        .item-count { font-size: 14px; font-weight: bold; position: absolute; bottom: 3px; }
        .item-count.icon-style { right: 4px; bottom: 1px; font-size: 12px; background-color: rgba(0,0,0,0.5); padding: 0 2px; border-radius: 2px;}
        .durability-bar { position: absolute; bottom: 2px; left: 10%; width: 80%; height: 4px; background-color: #D32F2F; } .durability-bar-inner { height: 100%; background-color: #4CAF50; }
        #message-log { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; font-size: 14px; opacity: 0; transition: opacity 0.5s; white-space: nowrap; }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; flex-direction: column; text-align: center; pointer-events: auto; z-index: 100; }
        .modal-content { position: relative; background-color: #2a2a2a; padding: 20px; border-radius: 10px; border: 1px solid #666; min-width: 320px; max-width: 90vw; max-height: 80vh; overflow-y: auto; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 30px; color: #aaa; cursor: pointer; display: none; }
        .recipe, .upgrade-row { background-color: #3a3a3a; margin-bottom: 10px; padding: 10px; border-radius: 5px; text-align: left; }
        .recipe button, .upgrade-row button { padding: 8px 12px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; float: right; margin-left: 5px;}
        .recipe button:disabled, .upgrade-row button:disabled { background-color: #666; color: #aaa; cursor: not-allowed; }
        .modal-button { padding: 10px 20px; font-size: 16px; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .modal-button-group { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; }
        #restart-button, #start-game-button { background-color: #f44336; } #reset-button, #resume-button { background-color: #2196F3; } #export-button { background-color: #009688; } #import-button-label { background-color: #FF9800; }
        .touch-controls { display: none; pointer-events: auto; }
        #joystick-container { position: absolute; bottom: 20px; left: 20px; width: 150px; height: 150px; }
        #joystick-base { position: relative; width: 100%; height: 100%; background: rgba(80, 80, 80, 0.5); border-radius: 50%; border: 2px solid rgba(200, 200, 200, 0.5); }
        #joystick-knob { position: absolute; width: 60px; height: 60px; background: rgba(180, 180, 180, 0.7); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        #action-buttons { position: absolute; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 20px; }
        .action-button { width: 70px; height: 70px; background: rgba(80, 80, 80, 0.6); border-radius: 50%; border: 2px solid rgba(200, 200, 200, 0.6); color: white; font-size: 16px; font-weight: bold; display: flex; justify-content: center; align-items: center; }
        #map-legend ul { list-style: none; padding: 0; text-align: left; } #map-legend li { display: flex; align-items: center; margin-bottom: 8px; }
        #mob-count-display { border-top: 1px solid #555; margin-top: 15px; padding-top: 15px; text-align: left; }
        .legend-icon { width: 32px; height: 32px; margin-right: 10px; border: 1px solid #555; background-size: cover; image-rendering: pixelated; }
        #full-inventory-menu .modal-content, #workbench-menu .modal-content { display: flex; flex-direction: column; }
        #full-inventory-hotbar { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 10px; }
        #full-inventory-hotbar .inventory-item.hotbar-slot { background-color: #444; border-style: dashed; }
        #full-inventory-bag { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 10px; }
        #full-inventory-menu h4, #workbench-menu h4, .modal-content h3, #merchant-menu h4 { text-align: left; margin: 10px 0 5px 0; border-bottom: 1px solid #555; padding-bottom: 5px; }
        #full-inventory-menu hr, #workbench-menu hr, #upgrade-menu hr, #merchant-menu hr { border-color: #444; width: 100%; margin: 15px 0; }
        #damage-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; box-shadow: inset 0 0 0 0 rgba(255, 0, 0, 0); pointer-events: none; z-index: 99; }
        #damage-overlay.flash { animation: damage-flash 0.4s ease-out; }
        .poison-overlay.flash { animation: poison-flash 1s ease-out infinite; }
        .starving-overlay { animation: starving-flash 1.2s ease-out infinite; }
        .intro-content p { text-align: left; text-indent: 2em; line-height: 1.6; margin: 10px 0; }
        .intro-content ul { list-style-position: inside; padding-left: 0; text-align: left; }
        .intro-content li { margin-bottom: 10px; line-height: 1.5; }
        @keyframes damage-flash { 0% { box-shadow: inset 0 0 0 0 rgba(255, 0, 0, 0); } 50% { box-shadow: inset 0 0 0 20px rgba(255, 0, 0, 0.5); } 100% { box-shadow: inset 0 0 0 0 rgba(255, 0, 0, 0); } }
        @keyframes poison-flash { 0% { box-shadow: inset 0 0 0 0px rgba(76, 175, 80, 0.4); } 50% { box-shadow: inset 0 0 0 15px rgba(76, 175, 80, 0.1); } 100% { box-shadow: inset 0 0 0 0px rgba(76, 175, 80, 0.4); } }
        @keyframes starving-flash { 0% { box-shadow: inset 0 0 0 0px rgba(255, 82, 82, 0.4); } 50% { box-shadow: inset 0 0 0 15px rgba(255, 82, 82, 0.1); } 100% { box-shadow: inset 0 0 0 0px rgba(255, 82, 82, 0.4); } }
        .progress-bar { position: absolute; width: 50px; height: 8px; background-color: rgba(0,0,0,0.7); border: 1px solid #fff; border-radius: 4px; display: none; }
        .progress-bar-inner { height: 100%; background-color: #FFC107; border-radius: 3px; }
        @media (orientation: landscape) and (max-height: 500px) { #joystick-container { width: 120px; height: 120px; bottom: 15px; left: 15px; } #joystick-knob { width: 50px; height: 50px; } .action-button { width: 60px; height: 60px; } #action-buttons { bottom: 20px; right: 20px; gap: 15px; } .inventory-item { width: 40px; height: 40px; } #message-log { bottom: 70px; font-size: 12px;} }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="ui-container">
            <div id="damage-overlay"></div><div id="taming-bar"><div id="taming-bar-inner"></div></div>
            <div id="top-left-ui"><div class="status-bar"><div id="hp-status"></div></div><div id="pet-status-bar"></div></div>
            <div class="top-left-buttons"><div id="fullscreen-button" class="ui-button"><div class="icon" style="width: 16px; height: 16px; border: 2px solid white;"></div></div></div>
            <div id="time-display"></div><div id="pause-button" class="ui-button" style="position:absolute; top:10px; right:10px;">||</div>
            <div id="message-log"></div><div id="inventory"></div>
            <div id="joystick-container" class="touch-controls"><div id="joystick-base"><div id="joystick-knob"></div></div></div>
            <div id="action-buttons" class="touch-controls"><div id="action-craft" class="action-button">合成</div></div>
            <div id="crafting-menu" class="modal"><div class="modal-content"><h2>合成選單<span class="close-button" id="crafting-close-button">&times;</span></h2><div id="recipes-list"></div></div></div>
            <div id="workbench-menu" class="modal"><div class="modal-content"><h2>工作台<span class="close-button" id="workbench-close-button">&times;</span></h2><div id="workbench-recipes-list"></div></div></div>
            <div id="pause-screen" class="modal"><div class="modal-content"><h1>遊戲暫停<span class="close-button" id="pause-close-button">&times;</span></h1><div id="map-legend"><h3>地圖圖例</h3><ul></ul></div><div id="mob-count-display"></div><div class="modal-button-group"><button id="resume-button" class="modal-button">繼續遊戲</button><button id="reset-button" class="modal-button">清除存檔並重開</button></div><div class="modal-button-group"><button id="export-button" class="modal-button">匯出存檔</button><label id="import-button-label" for="import-file" class="modal-button">匯入存檔</label><input type="file" id="import-file" accept=".txt" style="display: none;"/></div></div></div>
            <div id="upgrade-menu" class="modal"><div class="modal-content"><h2>角色升級<span class="close-button" id="upgrade-close-button">&times;</span></h2><div id="player-upgrade-section"></div><hr id="upgrade-divider" style="display:none;"><div id="pet-upgrade-section"></div></div></div>
            <div id="full-inventory-menu" class="modal"><div class="modal-content"><h2>背包<span class="close-button" id="inventory-close-button">&times;</span></h2><h4>快捷欄</h4><div id="full-inventory-hotbar"></div><hr><h4>主背包</h4><div id="full-inventory-bag"></div></div></div>
            <div id="game-over-screen" class="modal"><div class="modal-content"><h1>遊戲結束</h1><p id="survival-days-text"></p><button id="restart-button" class="modal-button">重新開始</button></div></div>
            <div id="merchant-menu" class="modal"><div class="modal-content"><h2>商人交易<span class="close-button" id="merchant-close-button">&times;</span></h2><h4>出售物品 (換取金幣)</h4><div id="sell-trades-list"></div><hr><h4>購買物品</h4><div id="buy-trades-list"></div><hr><div id="merchant-coin-display"></div></div></div>
            <div id="intro-screen" class="modal"><div class="modal-content intro-content">
                <h2>序章：意外的旅程</h2><p>一陣劇烈的晃動後，刺眼的陽光穿透眼皮。你在一片陌生的叢林中醒來，飛機的殘骸在不遠處冒著黑煙。記憶的碎片混亂不堪，但一個念頭無比清晰：必須活下去。</p><p>環顧四周，這裡是無邊無際的綠色煉獄，也是充滿生機的寶庫。你需要運用智慧和雙手，將這裡的資源變成你生存的希望。</p>
                <h3>新手生存指南</h3><ul><li><b>基本操作：</b>使用 <b>WASD鍵</b> 或畫面左下角的<b>虛擬搖桿</b>移動。點擊滑鼠或螢幕與環境互動。</li><li><b>生存狀態：</b>隨時注意畫面左上角的 ❤️生命、🍖飢餓、💧口渴。點擊此處可開啟升級選單。</li><li><b>合成是關鍵：</b>按 <b>C鍵</b> 或右下角的「合成」按鈕來製作基本工具。建造「工作台」可以解鎖更高級的配方。</li><li><b>小心劇毒：</b>野生的 🍄 (蘑菇) 有劇毒，直接食用會中毒並持續損失生命！但它們是製作某些藥劑的關鍵材料。</li><li><b>忠實的夥伴：</b>你可以馴服叢林中的 🐕 (狗)。只要靠近牠們足夠長的時間，牠們就會成為你的寵物。</li><li><b>寵物的功用：</b>寵物可以設定為「跟隨」、「待命」或「主動攻擊」模式。牠會幫你攻擊敵對生物，甚至幫你採集附近的蘑菇。你可以餵食 🍖 (熟肉) 來為牠恢復生命。</li><li><b>夜晚的危險：</b>夜晚時，環境會變暗，請小心行動。</li><li><b>遊玩建議：</b>建議使用手機並橫向遊玩以獲得最佳體驗。點擊左上角按鈕可進入全螢幕模式！</li></ul>
                <button id="start-game-button" class="modal-button">開始探索</button>
            </div></div>
        </div>
    </div>
<script>
    const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');
    const ui={hpStatus:document.getElementById('hp-status'),timeDisplay:document.getElementById('time-display'),inventoryDiv:document.getElementById('inventory'),messageLog:document.getElementById('message-log'),craftingMenu:document.getElementById('crafting-menu'),recipesList:document.getElementById('recipes-list'),gameOverScreen:document.getElementById('game-over-screen'),survivalDaysText:document.getElementById('survival-days-text'),restartButton:document.getElementById('restart-button'),pauseButton:document.getElementById('pause-button'),pauseScreen:document.getElementById('pause-screen'),resumeButton:document.getElementById('resume-button'),resetButton:document.getElementById('reset-button'),mapLegendList:document.querySelector('#map-legend ul'),joystickContainer:document.getElementById('joystick-container'),joystickKnob:document.getElementById('joystick-knob'),actionCraft:document.getElementById('action-craft'),craftingCloseButton:document.getElementById('crafting-close-button'),pauseCloseButton:document.getElementById('pause-close-button'),fullscreenButton:document.getElementById('fullscreen-button'),exportButton:document.getElementById('export-button'),importFile:document.getElementById('import-file'),fullInventoryMenu:document.getElementById('full-inventory-menu'),fullInventoryHotbar:document.getElementById('full-inventory-hotbar'),fullInventoryBag:document.getElementById('full-inventory-bag'),inventoryCloseButton:document.getElementById('inventory-close-button'),damageOverlay:document.getElementById('damage-overlay'),workbenchMenu:document.getElementById('workbench-menu'),workbenchRecipesList:document.getElementById('workbench-recipes-list'),workbenchCloseButton:document.getElementById('workbench-close-button'),tamingBar:document.getElementById('taming-bar'),tamingBarInner:document.getElementById('taming-bar-inner'),petStatusBar:document.getElementById('pet-status-bar'),introScreen:document.getElementById('intro-screen'),startGameButton:document.getElementById('start-game-button'),upgradeMenu:document.getElementById('upgrade-menu'),upgradeCloseButton:document.getElementById('upgrade-close-button'),playerUpgradeSection:document.getElementById('player-upgrade-section'),petUpgradeSection:document.getElementById('pet-upgrade-section'),upgradeDivider:document.getElementById('upgrade-divider'),mobCountDisplay:document.getElementById('mob-count-display'),merchantMenu:document.getElementById('merchant-menu'),sellTradesList:document.getElementById('sell-trades-list'),buyTradesList:document.getElementById('buy-trades-list'),merchantCloseButton:document.getElementById('merchant-close-button'),merchantCoinDisplay:document.getElementById('merchant-coin-display')};
    const TILE_SIZE=32,INTERACTION_DISTANCE=2.5,HOTBAR_SIZE=9,ARROW_SPEED=0.25;
    let player,world,keysPressed,gameTime,day,inventory,camera,selectedId,mobs,projectiles,activeFarms,merchantSpawnSchedule,lastMerchantCycle;
    let isGameOver=false,isPaused=false,isIntentionallyReloading=false;
    let joystick={active:false,vector:{x:0,y:0},rect:null,centerX:0,centerY:0,maxRadius:0};
    let lastMobSpawn=0,lastTime=0,gameLoopId=null,saveReminderTimer;
    let merchantData={id:null,trades:[],despawnTime:0};
    let playerImage=new Image();playerImage.src='https://labs.phaser.io/assets/sprites/chick.png';
    const PLAYER_SPRITE_WIDTH=16,PLAYER_SPRITE_HEIGHT=16,PLAYER_DRAW_WIDTH=TILE_SIZE,PLAYER_DRAW_HEIGHT=TILE_SIZE;
    let pAnimFrame=1,pAnimTimer=0;
    const PLAYER_ANIM_SPEED=100,ICON_REGEX=/(\p{Emoji_Presentation}|\p{Extended_Pictographic})/u;
    const TILE_TYPES={GRASS:{id:0,name:'草地',isPassable:true,color:'#4CAF50'},TREE:{id:1,name:'🌳',isPassable:false,color:'#2E7D32'},WATER:{id:2,name:'水',isPassable:false,color:'#1976D2'},ROCK:{id:3,name:'岩石',isPassable:true,color:'#757575'},BERRY_BUSH:{id:4,name:'漿果叢',isPassable:true,color:'#C2185B'},CAMPFIRE:{id:5,lit_color:'#FF9800',unlit_color:'#616161',name:'營火',isPassable:true,color:'#616161',fuel:0,maxFuel:200,isStructure:true},SHALLOW_WATER:{id:6,name:'淺水',isPassable:true,speedModifier:0.5,color:'#64B5F6'},WOOD_WALL:{id:9,name:'木牆',isPassable:false,color:'#8D6E63',isStructure:true},STONE_WALL:{id:10,name:'石牆',isPassable:false,color:'#78909C',isStructure:true},WOOD_DOOR:{id:11,name:'木門',isPassable:false,color:'#A1887F',isStructure:true},IRON_VEIN:{id:12,name:'鐵礦脈',isPassable:true,color:'#616161'},WORKBENCH:{id:13,name:'工作台',isPassable:true,color:'#a1887f',isStructure:true},IRON_WALL:{id:14,name:'鐵牆',isPassable:false,color:'#B0BEC5',isStructure:true},IRON_DOOR:{id:15,name:'鐵門',isPassable:false,color:'#90A4AE',isStructure:true},STONE_FLOOR:{id:16,name:'石地板',isPassable:true,color:'#BDBDBD',isStructure:true},BED:{id:17,name:'🛏️',isPassable:true,color:'#A1887F',isStructure:true},TILLED_SOIL:{id:18,name:'泥土地',isPassable:true,color:'#6D4C41',isStructure:false,state:'empty',crop:null,growthTimer:0,maxGrowth:10080,emptyCreationTime:0}};
    const ITEM_DEFS={'wood':{name:'🪵',isResource:true},'stick':{name:'樹枝',isResource:true},'stone':{name:'🪨',isResource:true},'flint':{name:'燧石',isResource:true},'berry':{name:'🍒',isConsumable:true,hunger:15,isResource:true},'axe':{name:'🪓',isWeapon:true,damage:25,maxDurability:40},'pickaxe':{name:'⛏️',isWeapon:true,damage:20,maxDurability:40},'campfire_kit':{name:'營火工具組',isPlaceable:true,places:TILE_TYPES.CAMPFIRE,isResource:true},'meat':{name:'🥩',isResource:true,isCookable:true},'cooked_meat':{name:'🍖',isConsumable:true,hunger:40,isResource:true},'wood_wall_kit':{name:'木牆工具組',isPlaceable:true,places:TILE_TYPES.WOOD_WALL,isResource:true},'stone_wall_kit':{name:'石牆工具組',isPlaceable:true,places:TILE_TYPES.STONE_WALL,isResource:true},'wood_door_kit':{name:'木門工具組',isPlaceable:true,places:TILE_TYPES.WOOD_DOOR,isResource:true},'stone_sword':{name:'石劍',isWeapon:true,damage:30,maxDurability:50},'diamond':{name:'💎',isResource:true},'gold':{name:'金礦',isResource:true},'gem':{name:'寶石',isResource:true},'iron_ore':{name:'鐵礦',isResource:true},'workbench_kit':{name:'工作台工具組',isPlaceable:true,places:TILE_TYPES.WORKBENCH,isResource:true},'iron_sword':{name:'🗡️',isWeapon:true,damage:45,maxDurability:80},'iron_wall_kit':{name:'鐵牆工具組',isPlaceable:true,places:TILE_TYPES.IRON_WALL,isResource:true},'iron_door_kit':{name:'鐵門工具組',isPlaceable:true,places:TILE_TYPES.IRON_DOOR,isResource:true},'mushroom':{name:'🍄',isConsumable:true,isPoisonous:true,isResource:true,isCookable:true},'mushroom_soup':{name:'🍲',isConsumable:true,hunger:50,health:20,thirst:10,isResource:true},'health_potion':{name:'🧪',isConsumable:true,health:200,isResource:true},'stone_floor_kit':{name:'石地板工具組',isPlaceable:true,places:TILE_TYPES.STONE_FLOOR,isResource:true},'bow':{name:'🏹',isWeapon:true,damage:40,maxDurability:60,isRanged:true},'arrow':{name:'箭',isResource:true},'bed_kit':{name:'🛏️',isPlaceable:true,places:TILE_TYPES.BED,isResource:true},'hoe':{name:'鋤頭',isWeapon:true,damage:5,maxDurability:60},'wheat_seeds':{name:'小麥種籽',isSeed:true,isResource:true,crop:'wheat'},'wheat':{name:'🌾',isResource:true},'dough':{name:'麵糰',isResource:true,isCookable:true},'bread':{name:'🥖',isConsumable:true,hunger:60,isResource:true},'coin':{name:'🪙',isResource:true},'deep_water_kit':{name:'深水地形',isPlaceable:true,places:TILE_TYPES.WATER,isResource:true},'shallow_water_kit':{name:'淺水地形',isPlaceable:true,places:TILE_TYPES.SHALLOW_WATER,isResource:true},'grass_kit':{name:'草地地形',isPlaceable:true,places:TILE_TYPES.GRASS,isResource:true}};
    const RECIPES={'axe':{result:{item:'axe',count:1},cost:[{item:'stick',count:3},{item:'flint',count:2}],name:'🪓'},'pickaxe':{result:{item:'pickaxe',count:1},cost:[{item:'stick',count:3},{item:'flint',count:3}],name:'⛏️'},'campfire_kit':{result:{item:'campfire_kit',count:1},cost:[{item:'stick',count:5},{item:'wood',count:5}],name:'營火工具組'},'workbench_kit':{result:{item:'workbench_kit',count:1},cost:[{item:'wood',count:8},{item:'stone',count:4}],name:'工作台工具組'},'wood_wall_kit':{result:{item:'wood_wall_kit',count:1},cost:[{item:'wood',count:4}],name:'木牆工具組',requires:'workbench'},'stone_wall_kit':{result:{item:'stone_wall_kit',count:1},cost:[{item:'stone',count:4}],name:'石牆工具組',requires:'workbench'},'wood_door_kit':{result:{item:'wood_door_kit',count:1},cost:[{item:'wood',count:6}],name:'木門工具組',requires:'workbench'},'stone_sword':{result:{item:'stone_sword',count:1},cost:[{item:'stick',count:2},{item:'stone',count:3}],name:'石劍',requires:'workbench'},'iron_sword':{result:{item:'iron_sword',count:1},cost:[{item:'stick',count:2},{item:'iron_ore',count:4}],name:'🗡️',requires:'workbench'},'iron_wall_kit':{result:{item:'iron_wall_kit',count:1},cost:[{item:'iron_ore',count:4}],name:'鐵牆工具組',requires:'workbench'},'iron_door_kit':{result:{item:'iron_door_kit',count:1},cost:[{item:'iron_ore',count:6}],name:'鐵門工具組',requires:'workbench'},'health_potion':{result:{item:'health_potion',count:1},cost:[{item:'mushroom',count:8},{item:'wood',count:1}],name:'生命藥水',requires:'workbench'},'stone_floor_kit':{result:{item:'stone_floor_kit',count:1},cost:[{item:'stone',count:2}],name:'石地板工具組',requires:'workbench'},'bow':{result:{item:'bow',count:1},cost:[{item:'stick',count:5},{item:'wood',count:3}],name:'弓🏹',requires:'workbench'},'arrow':{result:{item:'arrow',count:5},cost:[{item:'stick',count:1},{item:'flint',count:1}],name:'箭',requires:'workbench'},'bed_kit':{result:{item:'bed_kit',count:1},cost:[{item:'wood',count:10},{item:'stick',count:5}],name:'床工具組',requires:'workbench'},'hoe':{result:{item:'hoe',count:1},cost:[{item:'stick',count:2},{item:'stone',count:2}],name:'鋤頭',requires:'workbench'},'wheat_to_seeds':{result:{item:'wheat_seeds',count:4},cost:[{item:'wheat',count:1}],name:'小麥種籽×4',requires:'workbench'},'dough':{result:{item:'dough',count:1},cost:[{item:'wheat',count:4}],name:'麵糰',requires:'workbench'}};
    const MOB_TYPES={'pig':{name:'🐖',hp:40,speed:0.06,behavior:'passive',drops:{item:'meat',count:2}},'cow':{name:'🐂',hp:70,speed:0.04,behavior:'passive',drops:{item:'meat',count:3}},'sheep':{name:'🐑',hp:30,speed:0.05,behavior:'passive',drops:{item:'meat',count:1}},'dog':{name:'🐕',hp:100,speed:0.08,behavior:'passive',damage:8,drops:{item:'meat',count:1}},'leopard':{name:'🐆',hp:70,speed:0.09,behavior:'hostile',damage:20,drops:{item:'meat',count:2}},'rhino':{name:'🦏',hp:150,speed:0.04,behavior:'hostile',damage:25,drops:{item:'meat',count:4}},'snake':{name:'🐍',hp:60,speed:0.06,behavior:'hostile',damage:12,drops:{item:'meat',count:1}},'troll':{name:'🧌',hp:200,speed:0.03,behavior:'hostile',damage:30,drops:{item:'stone',count:5,item2:'meat',count2:3}},'dinosaur':{name:'🦕',hp:250,speed:0.03,behavior:'passive',drops:{item:'meat',count:10}},'rex':{name:'🦖',hp:300,speed:0.05,behavior:'hostile',damage:40,drops:{item:'meat',count:12,item2:'diamond',count2:1,chance:0.5}},'merchant':{name:'🧚‍♂️',hp:9999,speed:0.02,behavior:'trader',drops:{}}};
    const TRADE_POOL={sell:[{item:'wood',count:20,price:1},{item:'stone',count:20,price:1},{item:'flint',count:15,price:1},{item:'berry',count:10,price:1},{item:'meat',count:8,price:1},{item:'iron_ore',count:5,price:1},{item:'gem',count:2,price:2},{item:'diamond',count:1,price:5}],buy:[{item:'wheat_seeds',count:5,price:1,unlockDay:50},{item:'deep_water_kit',count:1,price:3,unlockDay:365},{item:'shallow_water_kit',count:1,price:2,unlockDay:365},{item:'grass_kit',count:1,price:1,unlockDay:365}]};
    const UPGRADE_LEVELS={player:[{hp:10,costs:[{item:'gold',count:5},{item:'gem',count:3},{item:'diamond',count:1}]},{hp:15,costs:[{item:'gold',count:10},{item:'gem',count:6},{item:'diamond',count:2}]},{hp:20,costs:[{item:'gold',count:20},{item:'gem',count:12},{item:'diamond',count:4}]},{hp:25,costs:[{item:'gold',count:35},{item:'gem',count:20},{item:'diamond',count:7}]},{hp:30,costs:[{item:'gold',count:50},{item:'gem',count:30},{item:'diamond',count:10}]}],pet:[{hp:20,costs:[{item:'gold',count:3},{item:'gem',count:2},{item:'diamond',count:1}]},{hp:30,costs:[{item:'gold',count:8},{item:'gem',count:5},{item:'diamond',count:2}]},{hp:50,costs:[{item:'gold',count:15},{item:'gem',count:10},{item:'diamond',count:4}]}]};
    playerImage.onload=()=>{init();};
    playerImage.onerror=()=>{console.error("Failed to load player sprite: chick.png.");init();};
    function init(){if(gameLoopId)cancelAnimationFrame(gameLoopId);isGameOver=false;isPaused=false;isIntentionallyReloading=false;ui.gameOverScreen.style.display='none';ui.pauseScreen.style.display='none';ui.craftingMenu.style.display='none';ui.workbenchMenu.style.display='none';ui.fullInventoryMenu.style.display='none';ui.upgradeMenu.style.display='none';ui.introScreen.style.display='none';ui.merchantMenu.style.display='none';resizeGame();window.addEventListener('resize',resizeGame);startNewGame();setupControls();populateMapLegend();updateUI();startGameLoop();}
    function getAbsoluteTime(){return(day-1)*1440+gameTime;}
    function checkAndGenerateMerchantSchedule(){const currentCycle=Math.floor((day-1)/10);if(currentCycle!==lastMerchantCycle){lastMerchantCycle=currentCycle;const daysInCycle=[0,1,2,3,4,5,6,7,8,9];for(let i=daysInCycle.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[daysInCycle[i],daysInCycle[j]]=[daysInCycle[j],daysInCycle[i]];}
    merchantSpawnSchedule=daysInCycle.slice(0,3);}}
    function startGameLoop(){if(gameLoopId)cancelAnimationFrame(gameLoopId);lastTime=performance.now();gameLoopId=requestAnimationFrame(gameLoop);}
    function startNewGame(){isPaused=true;player={x:0,y:0,hp:100,maxHp:100,hunger:100,maxHunger:100,thirst:100,maxThirst:100,speed:0.1,pet:null,taming:{target:null,timer:0,messageShown:false},poison:{active:false,timer:0,interval:null},action:{type:'none',timer:0,duration:0,onComplete:null},statusNotificationTimer:0,upgradeLevel:0,lastTileId:-1};inventory={resources:{},items:[],hotbar:Array(HOTBAR_SIZE).fill(null)};for(const key in ITEM_DEFS){if(!ITEM_DEFS[key].maxDurability&&ITEM_DEFS[key].isResource)inventory.resources[key]=0;}
    inventory.resources.stick=2;inventory.resources.berry=3;world={};mobs=[];projectiles=[];keysPressed={};gameTime=360;day=1;selectedId=null;saveReminderTimer=300000;camera={x:0,y:0};merchantData={id:null,trades:[],despawnTime:0};activeFarms=[];lastMerchantCycle=-1;merchantSpawnSchedule=[];checkAndGenerateMerchantSchedule();ui.introScreen.style.display='flex';}
    function resetGame(){if(confirm("確定要清除所有進度並重新開始嗎？此操作無法復原。")){isIntentionallyReloading=true;window.location.reload();}}
    function resizeGame(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;if('ontouchstart'in window||navigator.maxTouchPoints>0){recalculateJoystickBounds();}}
    function setupControls(){const isTouch='ontouchstart'in window||navigator.maxTouchPoints>0;if(isTouch){document.querySelectorAll('.touch-controls').forEach(el=>el.style.display='block');setupJoystick();canvas.addEventListener('touchstart',e=>{if(isPaused||isGameOver)return;const touch=e.touches[0];if(joystick.rect&&touch.clientX>=joystick.rect.left&&touch.clientX<=joystick.rect.right&&touch.clientY>=joystick.rect.top&&touch.clientY<=joystick.rect.bottom){return;}
    const rect=canvas.getBoundingClientRect();const mouseX=touch.clientX-rect.left;const mouseY=touch.clientY-rect.top;const worldX=(camera.x+mouseX)/TILE_SIZE;const worldY=(camera.y+mouseY)/TILE_SIZE;interact(worldX,worldY,true);},{passive:false});ui.actionCraft.addEventListener('click',()=>toggleCraftingMenu());}else{canvas.addEventListener('click',e=>{if(isPaused||isGameOver)return;const rect=canvas.getBoundingClientRect();const mouseX=e.clientX-rect.left;const mouseY=e.clientY-rect.top;const worldX=(camera.x+mouseX)/TILE_SIZE;const worldY=(camera.y+mouseY)/TILE_SIZE;interact(worldX,worldY,false);});}
    document.querySelectorAll('.close-button').forEach(el=>el.style.display='block');ui.fullscreenButton.addEventListener('click',toggleFullscreen);ui.hpStatus.parentElement.addEventListener('click',toggleUpgradeMenu);ui.petStatusBar.addEventListener('click',()=>{if(player.pet){const pet=mobs.find(m=>m.id===player.pet);if(pet){pet.attackTarget=null;pet.forageTarget=null;if(pet.stance==='follow')pet.stance='stay';else if(pet.stance==='stay')pet.stance='aggressive';else pet.stance='follow';pet.stayLocation={x:pet.x,y:pet.y};updateUI();}}});ui.startGameButton.addEventListener('click',()=>{ui.introScreen.style.display='none';isPaused=false;lastTime=performance.now();showMessage("在野外生存下去吧！");});ui.exportButton.addEventListener('click',exportSave);ui.importFile.addEventListener('change',importSave);ui.inventoryCloseButton.addEventListener('click',toggleFullInventory);ui.upgradeCloseButton.addEventListener('click',toggleUpgradeMenu);ui.damageOverlay.addEventListener('animationend',e=>{if(e.animationName==='damage-flash'){ui.damageOverlay.classList.remove('flash');}});ui.craftingCloseButton.addEventListener('click',()=>toggleCraftingMenu(false,true));ui.workbenchCloseButton.addEventListener('click',()=>toggleCraftingMenu(true,true));ui.merchantCloseButton.addEventListener('click',()=>toggleMerchantMenu(false));}
    function toggleFullscreen(){if(!document.fullscreenElement&&!document.webkitFullscreenElement){const e=document.documentElement;if(e.requestFullscreen)e.requestFullscreen();else if(e.webkitRequestFullscreen)e.webkitRequestFullscreen();}else{if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();}}
    function recalculateJoystickBounds(){const base=ui.joystickContainer.querySelector('#joystick-base');if(!base)return;joystick.rect=base.getBoundingClientRect();joystick.centerX=joystick.rect.left+joystick.rect.width/2;joystick.centerY=joystick.rect.top+joystick.rect.height/2;joystick.maxRadius=joystick.rect.width/2-ui.joystickKnob.offsetWidth/2;}
    function setupJoystick(){const base=ui.joystickContainer.querySelector('#joystick-base');recalculateJoystickBounds();const hT=e=>{if(!joystick.active)return;e.preventDefault();const t=e.touches[0];let dx=t.clientX-joystick.centerX,dy=t.clientY-joystick.centerY;const d=Math.hypot(dx,dy);if(d>joystick.maxRadius){dx=(dx/d)*joystick.maxRadius;dy=(dy/d)*joystick.maxRadius}ui.joystickKnob.style.transform=`translate(-50%,-50%) translate(${dx}px,${dy}px)`;if(d<10){joystick.vector={x:0,y:0};return}let a=Math.atan2(dy,dx);joystick.vector.x=Math.round(Math.cos(a)*2)/2;joystick.vector.y=Math.round(Math.sin(a)*2)/2;};base.addEventListener('touchstart',e=>{joystick.active=true;hT(e);},{passive:false});window.addEventListener('touchmove',hT,{passive:false});window.addEventListener('touchend',()=>{if(!joystick.active)return;joystick.active=false;joystick.vector={x:0,y:0};ui.joystickKnob.style.transform='translate(-50%,-50%)';});}
    function gameLoop(ts){if(isGameOver||isPaused){gameLoopId=requestAnimationFrame(gameLoop);return;}let dt=ts-lastTime;lastTime=ts;if(dt>100){dt=16.66;}update(dt);draw(dt);gameLoopId=requestAnimationFrame(gameLoop);}
    function update(dt){let isMoving=false;if(player.action.type==='none'){const pT=getTile(Math.floor(player.x),Math.floor(player.y));const speedMod=pT.speedModifier||1.0;let dx=joystick.vector.x,dy=joystick.vector.y;if(keysPressed['w']||keysPressed['ArrowUp'])dy-=1;if(keysPressed['s']||keysPressed['ArrowDown'])dy+=1;if(keysPressed['a']||keysPressed['ArrowLeft'])dx-=1;if(keysPressed['d']||keysPressed['ArrowRight'])dx+=1;isMoving=dx!==0||dy!==0;if(isMoving){const m=Math.hypot(dx,dy);const moveStep=player.speed*speedMod;const mX=(dx/m)*moveStep,mY=(dy/m)*moveStep;if(getTile(Math.floor(player.x+mX),Math.floor(player.y)).isPassable)player.x+=mX;if(getTile(Math.floor(player.x),Math.floor(player.y+mY)).isPassable)player.y+=mY;}}
    if(isMoving){pAnimTimer+=dt;if(pAnimTimer>=PLAYER_ANIM_SPEED){pAnimFrame=(pAnimFrame+1)%3;pAnimTimer=0;}}else{pAnimFrame=1;}
    if(player.action.type!=='none'){player.action.timer+=dt;if(player.action.timer>=player.action.duration){player.action.onComplete();player.action={type:'none',timer:0,duration:0,onComplete:null};}}
    saveReminderTimer-=dt;if(saveReminderTimer<=0){showMessage("提醒：記得適時匯出存檔喔！","#2196F3");saveReminderTimer=300000;}
    updateTaming(dt);camera.x=player.x*TILE_SIZE-canvas.width/2;camera.y=player.y*TILE_SIZE-canvas.height/2;updateTimeAndSurvival();updateWorld(dt);updateFarms(dt);updateMerchant(dt);updateMobs(dt);updateProjectiles(dt);updateUI();if(player.hp<=0)gameOver();}
    function takeDamage(amount,attacker=null){if(isGameOver)return;player.hp-=amount;ui.damageOverlay.classList.remove('flash');void ui.damageOverlay.offsetWidth;ui.damageOverlay.classList.add('flash');if(player.pet&&attacker&&attacker.id!==player.pet){const pet=mobs.find(m=>m.id===player.pet);if(pet)pet.attackTarget=attacker.id;}}
    function applyPoison(){if(player.poison.active)return;player.poison.active=true;player.poison.timer=10;showMessage("你中毒了！","#4CAF50");ui.damageOverlay.classList.add('poison-overlay','flash');player.poison.interval=setInterval(()=>{if(isGameOver||isPaused)return;takeDamage(5);player.poison.timer--;if(player.poison.timer<=0){clearInterval(player.poison.interval);player.poison.active=false;ui.damageOverlay.classList.remove('poison-overlay','flash');showMessage("中毒效果消失了","#4CAF50");}},1000);}
    function togglePause(){isPaused=!isPaused;if(isPaused){ui.pauseScreen.style.display='flex';const counts={};mobs.forEach(mob=>{counts[mob.type]=(counts[mob.type]||0)+1;});let countHtml=`<h3>世界生物統計 (總數: ${mobs.length}/${Math.min(500,10+day*2)})</h3><ul>`;const sortedMobTypes=Object.keys(MOB_TYPES).sort();sortedMobTypes.forEach(typeId=>{if(counts[typeId]){countHtml+=`<li>${MOB_TYPES[typeId].name} ${typeId}: ${counts[typeId]}</li>`;}});countHtml+=`</ul>`;ui.mobCountDisplay.innerHTML=countHtml;}else{ui.pauseScreen.style.display='none';ui.craftingMenu.style.display='none';ui.fullInventoryMenu.style.display='none';ui.upgradeMenu.style.display='none';ui.merchantMenu.style.display='none';lastTime=performance.now();}}
    function getTileKey(x,y){return`${x},${y}`;}
    function generateBaseTile(x,y){const cR=s=>()=>{let t=s+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};const r1=cR((x*73856093)^(y*19349663)),r2=cR((x*83492791)^(y*56934511));let tile={...TILE_TYPES.GRASS};if(r1()<0.04&&r2()<0.2)tile={...TILE_TYPES.WATER};else if(r1()<0.03)tile={...TILE_TYPES.BERRY_BUSH};else if(r1()<0.15)tile={...TILE_TYPES.ROCK};else if(r1()<0.40)tile={...TILE_TYPES.TREE};if(tile.id===TILE_TYPES.ROCK.id&&r2()<0.1)tile={...TILE_TYPES.IRON_VEIN};if(tile.id===TILE_TYPES.GRASS.id){if(r2()<0.01){tile.feature='mushroom';}else if(r2()<0.02)tile.groundItem='stick';else if(r2()<0.04)tile.groundItem='flint';}return tile;}
    function getTile(x,y){const k=getTileKey(x,y);if(world[k])return world[k];const n=[{dx:0,dy:1},{dx:0,dy:-1},{dx:1,dy:0},{dx:-1,dy:0}];for(const i of n){const nK=getTileKey(x+i.dx,y+i.dy);if(world[nK]&&world[nK].id===TILE_TYPES.WATER.id){const newTile=generateBaseTile(x,y);if(newTile.id!==TILE_TYPES.WATER.id)return world[k]={...TILE_TYPES.SHALLOW_WATER};}}
    const t=generateBaseTile(x,y);world[k]=t;if(t.id===TILE_TYPES.WATER.id){for(const i of n){const nK=getTileKey(x+i.dx,y+i.dy);if(world[nK]&&world[nK].id===TILE_TYPES.GRASS.id)world[nK]={...TILE_TYPES.SHALLOW_WATER};}}return t;}
    function updateTimeAndSurvival(){gameTime+=.2;if(gameTime>=1440){gameTime=0;day++;merchantData.despawnTime -= 1440;checkAndGenerateMerchantSchedule();}let survivalRate=1.0;const currentTile=getTile(Math.floor(player.x),Math.floor(player.y));if(currentTile.id===TILE_TYPES.BED.id){survivalRate=0.5;if(player.lastTileId!==currentTile.id)showMessage("在床上休息，飢餓與口渴消耗減緩。");}else if(currentTile.id===TILE_TYPES.STONE_FLOOR.id){survivalRate=0.75;}player.lastTileId=currentTile.id;
    player.thirst-=.01*survivalRate;player.hunger-=.005*survivalRate;const isStarving=player.hunger<=0;const isThirsty=player.thirst<=0;if(isThirsty){player.thirst=0;player.hp-=0.02;}
    if(isStarving){player.hunger=0;player.hp-=0.01;}if(player.statusNotificationTimer===undefined)player.statusNotificationTimer=0;player.statusNotificationTimer--;if(player.statusNotificationTimer<0&&(isStarving||isThirsty)){let msg='';if(isThirsty&&isStarving){msg='你極度飢餓且口渴！';}else if(isThirsty){msg='你非常口渴！';}else if(isStarving){msg='你快餓死了！';}if(msg){showMessage(msg+' 生命正在流失！','#f44336');player.statusNotificationTimer=180;}}
    if(player.hunger>50&&player.thirst>50&&player.hp<player.maxHp){player.hp=Math.min(player.hp+0.01,player.maxHp);}}
    function updateWorld(dt){const sX=Math.floor(camera.x/TILE_SIZE),sY=Math.floor(camera.y/TILE_SIZE),eX=sX+Math.ceil(canvas.width/TILE_SIZE),eY=sY+Math.ceil(canvas.height/TILE_SIZE);for(let y=sY;y<=eY;y++){for(let x=sX;x<=eX;x++){const key=getTileKey(x,y);const tile=world[key];if(!tile)continue;if(tile.isLit&&tile.id===TILE_TYPES.CAMPFIRE.id){tile.fuel-=0.05;if(tile.fuel<=0){tile.fuel=0;tile.isLit=false;showMessage("營火熄滅了");}}if(tile.isBurning){tile.burnTimer-=dt;if(tile.burnTimer<=0){const troll=mobs.find(m=>m.id===tile.burnerId);if(tile.originalId===TILE_TYPES.TREE.id){showMessage("森林巨人燒毀了樹木");}else{showMessage("一個建築被森林巨人燒毀了！");}world[key]={...TILE_TYPES.GRASS};if(troll)troll.state='idle';}}if(tile.id===TILE_TYPES.TILLED_SOIL.id){if(tile.state==='empty'){if(getAbsoluteTime()-tile.emptyCreationTime>=1440){const neighbors=[{dx:0,dy:1},{dx:0,dy:-1},{dx:1,dy:0},{dx:-1,dy:0}];let hasNaturalNeighbor=false;for(const n of neighbors){const neighborKey=getTileKey(x+n.dx,y+n.dy);const neighborTile=world[neighborKey];if(neighborTile&&[TILE_TYPES.GRASS.id,TILE_TYPES.TREE.id,TILE_TYPES.ROCK.id,TILE_TYPES.BERRY_BUSH.id].includes(neighborTile.id)){hasNaturalNeighbor=true;break;}}
    if(hasNaturalNeighbor){world[key]={...TILE_TYPES.GRASS};}else{tile.emptyCreationTime=getAbsoluteTime();}}}}}}}
    function updateFarms(dt){for(let i=activeFarms.length-1;i>=0;i--){const farmCoords=activeFarms[i];const key=getTileKey(farmCoords.x,farmCoords.y);const tile=world[key];if(!tile||tile.id!==TILE_TYPES.TILLED_SOIL.id||tile.state!=='growing'){activeFarms.splice(i,1);continue;}
    tile.growthTimer+=0.2;if(tile.growthTimer>=tile.maxGrowth){tile.state='mature';activeFarms.splice(i,1);}}}
    function updateProjectiles(dt){for(let i=projectiles.length-1;i>=0;i--){const p=projectiles[i];p.x+=p.vx*dt*0.1;p.y+=p.vy*dt*0.1;p.lifetime-=dt;if(p.lifetime<=0||!getTile(Math.floor(p.x),Math.floor(p.y)).isPassable){projectiles.splice(i,1);continue;}
    for(const mob of mobs){if(mob.type==='merchant')continue;const dist=Math.hypot(p.x-mob.x,p.y-mob.y);if(mob.id!==player.pet&&dist<0.6){mob.hp-=p.damage;if(mob.behavior==='hostile')mob.attackTarget='player';if(mob.behavior==='passive')mob.state='flee';showMessage(`對${MOB_TYPES[mob.type].name}造成 ${p.damage} 傷害`);projectiles.splice(i,1);break;}}}}
    function renderInventoryItem(itemData,count){const itemDef=ITEM_DEFS[itemData.type];const hasIcon=!itemDef.isSeed&&ICON_REGEX.test(itemDef.name);let nameClass=hasIcon?'item-name icon-style':'item-name';let countClass=hasIcon?'item-count icon-style':'item-count';let nameContent=itemDef.name;if(!hasIcon)nameContent=nameContent.substring(0,2);let html=`<span class="${nameClass}">${nameContent}</span>`;if(itemDef.isResource&&count!==undefined){html+=`<span class="${countClass}">${count}</span>`;}else if(itemData.durability!==undefined){html+=`<div class="durability-bar"><div class="durability-bar-inner" style="width:${itemData.durability/itemDef.maxDurability*100}%"></div></div>`;}return html;}
    function updateUI(){ui.hpStatus.innerHTML=`❤️ ${Math.ceil(player.hp)} / ${player.maxHp}&nbsp;&nbsp;🍖 ${Math.ceil(player.hunger)}&nbsp;&nbsp;💧 ${Math.ceil(player.thirst)}`;const h=Math.floor(gameTime/60).toString().padStart(2,'0'),m=Math.floor(gameTime%60).toString().padStart(2,'0');ui.timeDisplay.textContent=`D${day} ${h}:${m}`;if(player.pet){const pet=mobs.find(m=>m.id===player.pet);if(pet){ui.petStatusBar.style.display='block';const stanceText={follow:'跟隨',stay:'待命',aggressive:'攻擊'}[pet.stance];ui.petStatusBar.innerHTML=`🐕 HP: ${Math.ceil(pet.hp)}/${pet.maxHp} | 模式: [${stanceText}]`;}else{player.pet=null;ui.petStatusBar.style.display='none';}}else{ui.petStatusBar.style.display='none';}
    ui.inventoryDiv.innerHTML='';for(let i=0;i<HOTBAR_SIZE;i++){const itemId=inventory.hotbar[i];const d=document.createElement('div');d.className='inventory-item';if(itemId){const itemData=findItemById(itemId);if(itemData){const count=itemData.isResource?inventory.resources[itemData.type]:undefined;d.innerHTML=renderInventoryItem(itemData,count);d.onclick=()=>onInventoryClick(itemId);if(itemId===selectedId)d.classList.add('selected');}}ui.inventoryDiv.appendChild(d);}
    const hasMoreItems=inventory.items.some(item=>!inventory.hotbar.includes(item.id))||Object.keys(inventory.resources).some(key=>inventory.resources[key]>0&&!inventory.hotbar.includes(key));if(hasMoreItems){const moreBtn=document.createElement('div');moreBtn.className='inventory-item';moreBtn.innerHTML=`<span class="item-name">更多</span><span class="item-count">...</span>`;moreBtn.onclick=toggleFullInventory;ui.inventoryDiv.appendChild(moreBtn);}}
    function showMessage(msg,color='#f0f0f0'){ui.messageLog.style.color=color;ui.messageLog.textContent=msg;ui.messageLog.style.opacity=1;setTimeout(()=>ui.messageLog.style.opacity=0,2500);}
    function useDurability(itemId){const item=findItemById(itemId);if(item&&item.durability!==undefined){item.durability--;if(item.durability<=0){showMessage(`${ITEM_DEFS[item.type].name} 壞掉了！`);removeItem(itemId,true);if(selectedId===itemId)selectedId=null;}}}
    function onInventoryClick(itemId){selectedId=(selectedId===itemId)?null:itemId;const item=findItemById(itemId);const itemDef=item?ITEM_DEFS[item.type]:null;if(selectedId){showMessage(`選擇了 ${itemDef.name}`);}else{showMessage("取消選擇");}updateUI();}
    function interact(worldX,worldY,isTouch=false){if(player.action.type!=='none')return;
    const targetX=Math.floor(worldX),targetY=Math.floor(worldY);
    const dist=Math.hypot(player.x-targetX-0.5,player.y-targetY-0.5);
    const selectedItem=findItemById(selectedId);
    const selectedItemDef=selectedItem?ITEM_DEFS[selectedItem.type]:null;
    
    // Check for mob interaction first
    for(let i=mobs.length-1;i>=0;i--){
        const mob=mobs[i];
        const mobDist=Math.hypot(worldX-mob.x,worldY-mob.y);
        if(mobDist<0.8){
            if(mob.type==='merchant'){
                toggleMerchantMenu(true);return;
            }
            // If holding consumable, try to feed pet
            if(selectedItemDef && selectedItemDef.isConsumable && player.pet && mob.id === player.pet){
                if(!selectedItemDef.isPoisonous){
                    const petHeal=(selectedItemDef.health||0)+(selectedItemDef.hunger||0)*0.5;
                    if(petHeal>0){
                        pet.hp=Math.min(pet.hp+petHeal,pet.maxHp);
                        showMessage(`餵食了你的 ${pet.customName||'🐕'}！`);
                        inventory.resources[selectedId]--;
                        if(inventory.resources[selectedId]<=0){removeItem(selectedId,true);selectedId=null;}
                        updateUI();
                        return;
                    }
                } else {
                    showMessage("不能餵食這個給寵物！");
                    return;
                }
            }
            // Otherwise, attack mob
            attackMob(mob);
            return;
        }
    }
    
    // Check for player self-use
    if(selectedItemDef && selectedItemDef.isConsumable){
        const distToPlayer=Math.hypot(worldX-player.x,worldY-player.y);
        if(distToPlayer<0.8){
            if(selectedItemDef.isPoisonous){applyPoison();}
            else{
                player.hunger=Math.min(player.hunger+(selectedItemDef.hunger||0),player.maxHunger);
                player.thirst=Math.min(player.thirst+(selectedItemDef.thirst||0),player.maxThirst);
                player.hp=Math.min(player.hp+(selectedItemDef.health||0),player.maxHp);
                showMessage(`你使用了 ${selectedItemDef.name}`);
            }
            inventory.resources[selectedId]--;
            if(inventory.resources[selectedId]<=0){removeItem(selectedId,true);selectedId=null;}
            updateUI();
            return;
        }
    }
    
    // Ranged weapon
    if(selectedItemDef&&selectedItemDef.isRanged){if(inventory.resources.arrow>0){inventory.resources.arrow--;useDurability(selectedId);const dx=worldX-player.x;const dy=worldY-player.y;const mag=Math.hypot(dx,dy);const vx=(dx/mag)*ARROW_SPEED;const vy=(dy/mag)*ARROW_SPEED;projectiles.push({x:player.x,y:player.y,vx:vx,vy:vy,damage:selectedItemDef.damage,lifetime:2000});updateUI();}else{showMessage("沒有箭了!");}return;}

    // Tile interaction logic starts here
    if(dist>INTERACTION_DISTANCE){showMessage("太遠了");return;}
    
    const tile=getTile(targetX,targetY);
    const key = getTileKey(targetX, targetY);

    if (selectedItemDef && (selectedItem.type === 'deep_water_kit' || selectedItem.type === 'shallow_water_kit' || selectedItem.type === 'grass_kit')) {
        let isValidTarget = true;
        let newTileType = null;
        let successMessage = "";

        if (tile.isStructure && tile.id !== TILE_TYPES.TILLED_SOIL.id) {
            isValidTarget = false;
            showMessage("無法在這裡改變地形 (有建築物)");
        }
        if (targetX === Math.floor(player.x) && targetY === Math.floor(player.y)) {
             isValidTarget = false;
             showMessage("不能在自己腳下改變地形");
        }

        if (isValidTarget) {
            switch (selectedItem.type) {
                case 'deep_water_kit':
                    if ([TILE_TYPES.GRASS.id, TILE_TYPES.SHALLOW_WATER.id, TILE_TYPES.TILLED_SOIL.id].includes(tile.id)) {
                        newTileType = TILE_TYPES.WATER;
                        successMessage = "將地塊變成了深水";
                    } else {
                        isValidTarget = false; showMessage("只能在草地、淺水或泥土地上變成深水");
                    }
                    break;
                case 'shallow_water_kit':
                     if ([TILE_TYPES.GRASS.id, TILE_TYPES.TILLED_SOIL.id].includes(tile.id)) {
                        newTileType = TILE_TYPES.SHALLOW_WATER;
                        successMessage = "將地塊變成了淺水";
                    } else {
                        isValidTarget = false; showMessage("只能在草地或泥土地上變成淺水");
                    }
                    break;
                case 'grass_kit':
                    newTileType = TILE_TYPES.GRASS;
                    successMessage = "將地塊變成了草地";
                    break;
            }
        }
        
        if (isValidTarget && newTileType) {
            if (tile.id === TILE_TYPES.TILLED_SOIL.id && tile.state === 'growing') {
                const farmIndex = activeFarms.findIndex(f => f.x === targetX && f.y === targetY);
                if (farmIndex > -1) activeFarms.splice(farmIndex, 1);
            }
            world[key] = { ...newTileType };
            inventory.resources[selectedId]--;
            if (inventory.resources[selectedId] <= 0) { removeItem(selectedId, true); selectedId = null;}
            showMessage(successMessage);
            updateUI();
            return;
        }
    }


    if(selectedItem&&selectedItemDef&&selectedItemDef.isPlaceable){ // Original isPlaceable logic for structures
        if(targetX===Math.floor(player.x)&&targetY===Math.floor(player.y)){showMessage("不能在自己腳下建造");return;}
        const targetTile=getTile(targetX,targetY);
        if((targetTile.id===TILE_TYPES.GRASS.id||targetTile.id===TILE_TYPES.ROCK.id||targetTile.id===TILE_TYPES.STONE_FLOOR.id)&&!targetTile.groundItem&&!targetTile.feature){let newTile={...selectedItemDef.places};if(newTile.id===TILE_TYPES.CAMPFIRE.id){Object.assign(newTile,{isLit:false,fuel:0,maxFuel:TILE_TYPES.CAMPFIRE.maxFuel});}if(newTile.id===TILE_TYPES.WOOD_DOOR.id||newTile.id===TILE_TYPES.IRON_DOOR.id){Object.assign(newTile,{isOpen:false,isPassable:false});}
        world[getTileKey(targetX,targetY)]=newTile;showMessage(`放置了 ${ITEM_DEFS[selectedItem.type].name}`);if(selectedItem.isResource){inventory.resources[selectedId]--;if(inventory.resources[selectedId]<=0){removeItem(selectedId,true);selectedId=null;}}else{removeItem(selectedId,true);selectedId=null;}updateUI();}else{showMessage("無法在此放置");}return;}
    
    let actionTaken=false;
    if(tile.groundItem){addResource(tile.groundItem,1);showMessage("撿起了 "+ITEM_DEFS[tile.groundItem].name);delete tile.groundItem;actionTaken=true;}else if(tile.feature==='mushroom'){addResource('mushroom',1);showMessage("採集了 🍄");delete tile.feature;actionTaken=true;}else{const equippedWeapon=findItemById(selectedId);const equippedWeaponType=equippedWeapon?equippedWeapon.type:null;switch(tile.id){case TILE_TYPES.GRASS.id:if(equippedWeaponType==='hoe'){world[key]={...TILE_TYPES.TILLED_SOIL,state:'empty',crop:null,growthTimer:0,emptyCreationTime:getAbsoluteTime()};useDurability(selectedId);showMessage("你犁了一塊地");actionTaken=true;}break;case TILE_TYPES.TILLED_SOIL.id:
    if(tile.state==='growing'&&equippedWeaponType==='hoe'){ // New: Use hoe to remove growing crop
        const farmIndex=activeFarms.findIndex(f=>f.x===targetX&&f.y===targetY);
        if(farmIndex>-1)activeFarms.splice(farmIndex,1);
        world[key]={...TILE_TYPES.TILLED_SOIL,state:'empty',crop:null,growthTimer:0,emptyCreationTime:getAbsoluteTime()};
        useDurability(selectedId);
        showMessage("你剷除了作物");
        actionTaken=true;
    }else if(tile.state==='empty'&&selectedItemDef&&selectedItemDef.isSeed){inventory.resources[selectedId]--;if(inventory.resources[selectedId]<=0){removeItem(selectedId,true);selectedId=null;}tile.state='growing';tile.crop=selectedItemDef.crop;tile.growthTimer=0;activeFarms.push({x:targetX,y:targetY});showMessage("種下了"+selectedItemDef.name);actionTaken=true;}else if(tile.state==='growing'){showMessage("正在種植 "+ITEM_DEFS[tile.crop].name);}else if(tile.state==='mature'){addResource(tile.crop,1);showMessage("收穫了 1 "+ITEM_DEFS[tile.crop].name);tile.state='empty';tile.crop=null;tile.growthTimer=0;tile.emptyCreationTime=getAbsoluteTime();actionTaken=true;}break;case TILE_TYPES.BERRY_BUSH.id:addResource('berry',1);world[key]={...TILE_TYPES.GRASS};showMessage("採集了漿果");actionTaken=true;break;case TILE_TYPES.CAMPFIRE.id:if(equippedWeaponType==='axe'){world[key]={...TILE_TYPES.GRASS};addResource('stick',2);addResource('wood',2);useDurability(selectedId);actionTaken=true;break;}
    
    let itemToCook=null;
    if(selectedId&&ITEM_DEFS[selectedId]&&ITEM_DEFS[selectedId].isCookable&&(inventory.resources[selectedId]>0)){itemToCook=selectedId;}
    
    if(tile.isLit && itemToCook){
        const recipe = {'meat':'cooked_meat','mushroom':'mushroom_soup','dough':'bread'};
        const resultItem = recipe[itemToCook];
        if (resultItem) {
            showMessage("正在烹飪...");player.action={type:'cooking',timer:0,duration:3000,onComplete:()=>{inventory.resources[itemToCook]--;if(inventory.resources[itemToCook]<=0){removeItem(itemToCook,true);if(selectedId===itemToCook)selectedId=null;}
            addResource(resultItem,1);showMessage(`烹飪完成了！獲得 ${ITEM_DEFS[resultItem].name}`);updateUI();}};}
        else{showMessage("這個無法烹飪！");}
        actionTaken = true; // Mark action as taken to prevent falling through to other logic
    }
    else if(tile.isLit&&selectedId==='stick'&&inventory.resources.stick>0){inventory.resources.stick--;if(inventory.resources.stick<=0){removeItem('stick',true);selectedId=null;}tile.fuel=Math.min(tile.fuel+50,tile.maxFuel);showMessage("添加了燃料");actionTaken=true;}
    else if(!tile.isLit&&inventory.resources.stick>0){inventory.resources.stick--;if(inventory.resources.stick<=0){removeItem('stick',true);selectedId=null;}tile.isLit=true;tile.fuel=100;showMessage("點燃營火");actionTaken=true;}
    else if(!tile.isLit){showMessage("需要樹枝");}break;case TILE_TYPES.WORKBENCH.id:if(equippedWeaponType==='axe'){world[key]={...TILE_TYPES.GRASS};addResource('wood',4);addResource('stone',2);useDurability(selectedId);showMessage("拆毀了工作台");actionTaken=true;}else{toggleCraftingMenu(true);}break;case TILE_TYPES.TREE.id:if(equippedWeaponType==='axe'){addResource('wood',2);addResource('stick',1);world[key]={...TILE_TYPES.GRASS};useDurability(selectedId);actionTaken=true;}else{showMessage("你需要裝備一把斧頭");}break;case TILE_TYPES.ROCK.id:if(equippedWeaponType==='pickaxe'){addResource('stone',2);addResource('flint',1);const rand=Math.random();if(rand<0.02){addResource('diamond',1);showMessage("挖到了💎！");}else if(rand<0.07){addResource('gold',1);showMessage("挖到了金礦！");}else if(rand<0.17){addResource('gem',1);showMessage("挖到了寶石！");}world[key]={...TILE_TYPES.GRASS};useDurability(selectedId);actionTaken=true;}else{takeDamage(1);addResource('flint',1);showMessage("用手敲擊岩石，獲得1燧石但受了點傷");actionTaken=true;}break;case TILE_TYPES.IRON_VEIN.id:if(equippedWeaponType==='pickaxe'){addResource('iron_ore',2);world[key]={...TILE_TYPES.GRASS};useDurability(selectedId);showMessage("挖到了鐵礦！");actionTaken=true;}else{showMessage("需要裝備鎬子");}break;case TILE_TYPES.WOOD_WALL.id:if(equippedWeaponType==='axe'){world[key]={...TILE_TYPES.GRASS};addResource('wood',2);useDurability(selectedId);actionTaken=true;}else{showMessage("需要裝備斧頭來拆除");}break;case TILE_TYPES.STONE_WALL.id:if(equippedWeaponType==='pickaxe'){world[key]={...TILE_TYPES.GRASS};addResource('stone',2);useDurability(selectedId);actionTaken=true;}else{showMessage("需要裝備鎬子來拆除");}break;case TILE_TYPES.WOOD_DOOR.id:if(equippedWeaponType==='axe'){world[key]={...TILE_TYPES.GRASS};addResource('wood',3);useDurability(selectedId);showMessage("拆毀了木門");actionTaken=true;}else{tile.isOpen=!tile.isOpen;tile.isPassable=tile.isOpen;showMessage(tile.isOpen?"打開木門":"關上木門");actionTaken=true;}break;case TILE_TYPES.IRON_WALL.id:if(equippedWeaponType==='iron_sword'){world[key]={...TILE_TYPES.GRASS};addResource('iron_ore',2);useDurability(selectedId);actionTaken=true;}else{showMessage("需要裝備鐵劍來拆除");}break;case TILE_TYPES.IRON_DOOR.id:if(equippedWeaponType==='iron_sword'){world[key]={...TILE_TYPES.GRASS};addResource('iron_ore',3);useDurability(selectedId);showMessage("拆毀了鐵門");actionTaken=true;}else{tile.isOpen=!tile.isOpen;tile.isPassable=tile.isOpen;showMessage(tile.isOpen?"打開鐵門":"關上鐵門");actionTaken=true;}break;case TILE_TYPES.STONE_FLOOR.id:if(equippedWeaponType==='pickaxe'){world[key]={...TILE_TYPES.GRASS};addResource('stone',1);useDurability(selectedId);actionTaken=true;}break;case TILE_TYPES.BED.id:if(equippedWeaponType==='axe'){world[key]={...TILE_TYPES.GRASS};addResource('wood',5);addResource('stick',2);useDurability(selectedId);actionTaken=true;}else{showMessage("一張舒適的床");}break;case TILE_TYPES.WATER.id:case TILE_TYPES.SHALLOW_WATER.id:player.thirst=Math.min(player.thirst+5,player.maxThirst);showMessage("喝了點水");actionTaken=true;break;}}
    if(actionTaken){updateUI();}}
    function addItem(itemType,count=1){const itemDef=ITEM_DEFS[itemType];if(itemDef.maxDurability){for(let i=0;i<count;i++){const newItem={id:'item_'+Date.now()+Math.random(),type:itemType,durability:Math.floor(itemDef.maxDurability*(0.75+Math.random()*0.25))};inventory.items.push(newItem);const emptySlot=inventory.hotbar.indexOf(null);if(emptySlot!==-1){inventory.hotbar[emptySlot]=newItem.id;}}}else{addResource(itemType,count);}}
    function addResource(resourceType,count){if(!inventory.resources[resourceType])inventory.resources[resourceType]=0;inventory.resources[resourceType]+=count;if(!inventory.hotbar.includes(resourceType)&&inventory.resources[resourceType]>0){const emptySlot=inventory.hotbar.indexOf(null);if(emptySlot!==-1)inventory.hotbar[emptySlot]=resourceType;}}
    function findItemById(id){if(!id)return null;if(ITEM_DEFS[id]&&ITEM_DEFS[id].isResource)return{id:id,type:id,isResource:true};return inventory.items.find(item=>item.id===id)||null;}
    function removeItem(id,forceRemove=false){if(!id)return;const item=findItemById(id);if(!item)return;if(item.isResource){if(forceRemove){delete inventory.resources[id];}else{if(inventory.resources[id]>0)inventory.resources[id]--;}}else{inventory.items=inventory.items.filter(i=>i.id!==id);}const hotbarIndex=inventory.hotbar.indexOf(id);if(hotbarIndex!==-1&&(forceRemove||(item.isResource&&(!inventory.resources[id]||inventory.resources[id]<=0)))){inventory.hotbar[hotbarIndex]=null;}}
    function spawnMob(){if(merchantData.id!==null&&mobs.length>=Math.min(500,10+day*2))return;const r_min=Math.max(canvas.width,canvas.height)/TILE_SIZE/2+5;const r_max=r_min*5;const radius=r_min+Math.random()*(r_max-r_min);const angle=Math.random()*2*Math.PI;const x=player.x+Math.cos(angle)*radius;const y=player.y+Math.sin(angle)*radius;const tileX=Math.floor(x);const tileY=Math.floor(y);if(!getTile(tileX,tileY).isPassable)return;const BUILD_CHECK_RADIUS=5;for(let dy=-BUILD_CHECK_RADIUS;dy<=BUILD_CHECK_RADIUS;dy++){for(let dx=-BUILD_CHECK_RADIUS;dx<=BUILD_CHECK_RADIUS;dx++){const checkTile=getTile(tileX+dx,tileY+dy);if(checkTile.isStructure){return;}}}
    const rand=Math.random();let typeId;if(rand<0.65){const passiveMobs=['pig','cow','sheep','dog'];typeId=passiveMobs[Math.floor(Math.random()*passiveMobs.length)];}else if(rand<0.70){typeId='dinosaur';}else if(rand<0.95){const hostileMobs=['leopard','rhino','snake','troll'];typeId=hostileMobs[Math.floor(Math.random()*hostileMobs.length)];}else{typeId='rex';}
    const type=MOB_TYPES[typeId];const strength=0.8+Math.random()*0.4;const hp=Math.round(type.hp*strength);mobs.push({id:Date.now()+Math.random(),type:typeId,x:x,y:y,hp:hp,maxHp:hp,state:'idle',state_timer:Math.random()*300,vx:0,vy:0,behavior:type.behavior,attackTarget:null,upgradeLevel:0});}
    function isPathClear(x1,y1,x2,y2){const dx=x2-x1;const dy=y2-y1;const steps=Math.floor(Math.max(Math.abs(dx),Math.abs(dy)));if(steps===0)return true;const x_inc=dx/steps;const y_inc=dy/steps;let x=x1;let y=y1;for(let i=0;i<steps;i++){x+=x_inc;y+=y_inc;const tile=getTile(Math.floor(x),Math.floor(y));if(!tile.isPassable){return false;}}return true;}
    function updateTaming(dt){let tamingDog=null;if(!player.pet){for(const mob of mobs){if(mob.type==='dog'&&mob.behavior==='passive'){const dist=Math.hypot(player.x-mob.x,player.y-mob.y);if(dist<1.0){tamingDog=mob;break;}}}}
    if(tamingDog){if(player.taming.target!==tamingDog.id){player.taming.target=tamingDog.id;player.taming.timer=0;player.taming.messageShown=false;}if(!player.taming.messageShown){showMessage("正在馴服 🐕...");player.taming.messageShown=true;}
    player.taming.timer+=dt;ui.tamingBar.style.display='block';const progress=Math.min(player.taming.timer/10000,1);ui.tamingBarInner.style.width=`${progress*100}%`;if(player.taming.timer>=10000){tamingDog.behavior='tamed';tamingDog.stance='follow';const petName=prompt("為你的新夥伴取個名字吧！","小夥伴");tamingDog.customName=petName||"小夥伴";player.pet=tamingDog.id;showMessage(`你馴服了 ${tamingDog.customName}！`);player.taming.target=null;player.taming.timer=0;ui.tamingBar.style.display='none';}}else{if(player.taming.target){player.taming.target=null;player.taming.timer=0;ui.tamingBar.style.display='none';}}}
    function updateMerchant(dt){const dayInCycle=(day-1)%10;if(merchantData.id===null&&merchantSpawnSchedule.includes(dayInCycle)&&gameTime>=0&&gameTime<1){const angle=Math.random()*2*Math.PI;const x=player.x+Math.cos(angle)*8;const y=player.y+Math.sin(angle)*8;if(getTile(Math.floor(x),Math.floor(y)).isPassable){const type=MOB_TYPES['merchant'];const newMerchant={id:Date.now()+Math.random(),type:'merchant',x:x,y:y,hp:type.hp,maxHp:type.hp,state:'idle',state_timer:9999,vx:0,vy:0,behavior:type.behavior,attackTarget:null};mobs.push(newMerchant);merchantData.id=newMerchant.id;merchantData.despawnTime=gameTime+1440;generateMerchantTrades();showMessage("一位神秘的商人出現了！","#FFEB3B");}}
    if(merchantData.id!==null){const merchantMob=mobs.find(m=>m.id===merchantData.id);if(!merchantMob||gameTime>=merchantData.despawnTime){if(merchantMob){const index=mobs.findIndex(m=>m.id===merchantData.id);if(index>-1)mobs.splice(index,1);showMessage("商人消失在薄霧中...","#FFEB3B");}merchantData.id=null;merchantData.trades=[];merchantData.despawnTime=0;if(ui.merchantMenu.style.display==='flex'){toggleMerchantMenu(false);}}}}
    function updateMobs(dt){const maxMobs=Math.min(500,10+day*2);if(performance.now()-lastMobSpawn>10000&&mobs.length<maxMobs){spawnMob();lastMobSpawn=performance.now();}
    for(let i=mobs.length-1;i>=0;i--){const mob=mobs[i];if(!mob)continue;if(mob.type==='merchant')continue;const type=MOB_TYPES[mob.type];let targetEntity=null;if(mob.attackTarget){if(mob.attackTarget==='player'){targetEntity=player;}else{targetEntity=mobs.find(m=>m.id===mob.attackTarget);}if(!targetEntity||targetEntity.hp<=0){mob.attackTarget=null;targetEntity=null;}}
    if(mob.behavior==='tamed'){mob.hp=Math.min(mob.hp+0.005,mob.maxHp);if(mob.stance==='stay'){mob.state='idle';}else if(mob.stance==='aggressive'&&!targetEntity){for(const otherMob of mobs){if(otherMob.behavior==='hostile'&&otherMob.id!==mob.id){const distToEnemy=Math.hypot(otherMob.x-mob.x,otherMob.y-mob.y);if(distToEnemy<8){mob.attackTarget=otherMob.id;showMessage(`你的 🐕 主動攻擊 ${MOB_TYPES[otherMob.type].name}!`);break;}}}}
    if(targetEntity){mob.state='chase_enemy';let distToEnemy=Math.hypot(targetEntity.x-mob.x,targetEntity.y-mob.y);if(distToEnemy<1.0){targetEntity.hp-=type.damage*(dt/16.6);mob.state='attacking_enemy';if(targetEntity!==player)targetEntity.attackTarget=mob.id;}}else if(mob.stance!=='stay'){let distToPlayer=Math.hypot(player.x-mob.x,player.y-mob.y);if(distToPlayer>2.5){mob.state='follow';}else{mob.state='idle';if(mob.stance==='follow'&&Math.random()<0.01){for(let dx=-5;dx<=5;dx++){for(let dy=-5;dy<=5;dy++){const tileX=Math.floor(mob.x+dx),tileY=Math.floor(mob.y+dy);if(getTile(tileX,tileY).feature==='mushroom'&&isPathClear(mob.x,mob.y,tileX+0.5,tileY+0.5)){mob.forageTarget={x:tileX,y:tileY};break;}}if(mob.forageTarget)break;}}}}}
    else{let chaseTarget=targetEntity||(mob.behavior==='hostile'?player:null);if(mob.state==='attacking'){mob.state_timer-=dt/16.6;if(mob.state_timer<=0)mob.state='chase';}else if(mob.behavior==='passive'){if(mob.attackTarget){mob.state='flee';}else{let distToPlayer=Math.hypot(player.x-mob.x,player.y-mob.y);if(distToPlayer<5)mob.state='flee';else if(distToPlayer>8&&mob.state==='flee')mob.state='idle';}}
    else if(mob.behavior==='hostile'){if(mob.type==='troll'&&mob.state==='burning_obstacle'){}else{if(!chaseTarget){let pet=mobs.find(m=>m.id===player.pet);let distToPlayer=Math.hypot(player.x-mob.x,player.y-mob.y);let distToPet=pet?Math.hypot(pet.x-mob.x,pet.y-mob.y):Infinity;if(distToPlayer<8&&distToPlayer<=distToPet)chaseTarget=player;else if(distToPet<8)chaseTarget=pet;}
    if(chaseTarget){let distToTarget=Math.hypot(chaseTarget.x-mob.x,chaseTarget.y-mob.y);if(distToTarget<1.5){mob.state='attacking';mob.state_timer=50;if(chaseTarget===player){takeDamage(type.damage,mob);}else{chaseTarget.hp-=type.damage;}}else if(distToTarget<8||mob.attackTarget){mob.state='chase';mob.attackTarget=chaseTarget.id||'player';}else if(distToTarget>12){mob.state='idle';mob.attackTarget=null;}}else{mob.state='idle';mob.attackTarget=null;}}}}
    let moveX=0,moveY=0;switch(mob.state){case'flee':moveX=mob.x-player.x;moveY=mob.y-player.y;break;case'chase':let chaseTarget=targetEntity||(mob.attackTarget==='player'?player:null);if(chaseTarget){moveX=chaseTarget.x-mob.x;moveY=chaseTarget.y-mob.y;}break;case'follow':moveX=player.x-mob.x;moveY=player.y-mob.y;break;case'chase_enemy':if(targetEntity){moveX=targetEntity.x-mob.x;moveY=targetEntity.y-mob.y;}break;case'idle':if(mob.behavior==='tamed'&&mob.stance==='stay'){let distToStayPoint=Math.hypot(mob.stayLocation.x-mob.x,mob.stayLocation.y-mob.y);if(distToStayPoint>0.5){moveX=mob.stayLocation.x-mob.x;moveY=mob.stayLocation.y-mob.y;}else{mob.vx=0;mob.vy=0;moveX=0;moveY=0;}}else if(mob.behavior==='trader'){moveX=0;moveY=0;}else if(mob.state_timer>0){mob.state_timer-=dt/16.6;if(mob.behavior==='tamed'&&mob.stance==='follow'){moveX=0;moveY=0;}else{moveX=mob.vx;moveY=mob.vy;}}else{mob.vx=(Math.random()-0.5)*0.5;mob.vy=(Math.random()-0.5)*0.5;mob.state_timer=Math.random()*200+100;moveX=mob.vx;moveY=mob.vy;}break;}
    const mag=Math.hypot(moveX,moveY);if(mag>0.1&&mob.state!=='attacking'&&mob.state!=='burning_obstacle'){const moveSpeed=type.speed*(dt/(1000/60));const finalX=mob.x+(moveX/mag)*moveSpeed;const finalY=mob.y+(moveY/mag)*moveSpeed;const tileX=getTile(Math.floor(finalX),Math.floor(mob.y));const tileY=getTile(Math.floor(mob.x),Math.floor(finalY));if(tileX.isPassable)mob.x=finalX;else if(mob.type==='troll'&&(tileX.id===TILE_TYPES.WOOD_WALL.id||tileX.id===TILE_TYPES.WOOD_DOOR.id||tileX.id===TILE_TYPES.TREE.id)){if(!tileX.isBurning){tileX.isBurning=true;tileX.burnTimer=3000;tileX.burnerId=mob.id;tileX.originalId=tileX.id;mob.state='burning_obstacle';}}
    if(tileY.isPassable)mob.y=finalY;else if(mob.type==='troll'&&(tileY.id===TILE_TYPES.WOOD_WALL.id||tileY.id===TILE_TYPES.WOOD_DOOR.id||tileY.id===TILE_TYPES.TREE.id)){if(!tileY.isBurning){tileY.isBurning=true;tileY.burnTimer=3000;tileY.burnerId=mob.id;tileY.originalId=tileY.id;mob.state='burning_obstacle';}}}
    if(mob.hp<=0){if(mob.id===player.pet){player.pet=null;showMessage("你的 🐕 陣亡了...");}else{const drops=MOB_TYPES[mob.type].drops;let killMessage=`擊殺了 ${MOB_TYPES[mob.type].name}!`;if(drops){addResource(drops.item,drops.count);killMessage+=` 獲得了 ${drops.count} ${ITEM_DEFS[drops.item].name}`;if(drops.item2&&(!drops.chance||Math.random()<drops.chance)){addResource(drops.item2,drops.count2);killMessage+=`、${drops.count2} ${ITEM_DEFS[drops.item2].name}`;}}
    showMessage(killMessage);}mobs.splice(i,1);}}}
    function attackMob(mob){if(mob.type==='merchant'){showMessage("這位仙子看起來不想打架。");return;}const weapon=findItemById(selectedId);const weaponDef=weapon?ITEM_DEFS[weapon.type]:null;const damage=(weaponDef&&weaponDef.isWeapon&&!weaponDef.isRanged)?weaponDef.damage:5;mob.hp-=damage;if(mob.behavior==='passive')mob.state='flee';if(mob.behavior==='hostile')mob.attackTarget='player';if(weaponDef&&weaponDef.isWeapon&&!weaponDef.isRanged)useDurability(selectedId);showMessage(`對${MOB_TYPES[mob.type].name}造成 ${damage} 傷害`);}
    function drawMobs(){mobs.forEach(mob=>{const screenX=mob.x*TILE_SIZE-camera.x;const screenY=mob.y*TILE_SIZE-camera.y;const type=MOB_TYPES[mob.type];ctx.font=`${TILE_SIZE*0.8}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(type.name,screenX,screenY);if(mob.hp<mob.maxHp&&mob.type!=='merchant'){const hpBarY=screenY-TILE_SIZE*0.7;ctx.fillStyle='#D32F2F';ctx.fillRect(screenX-TILE_SIZE/2,hpBarY,TILE_SIZE,5);ctx.fillStyle='#4CAF50';ctx.fillRect(screenX-TILE_SIZE/2,hpBarY,TILE_SIZE*(mob.hp/mob.maxHp),5);}
    if(mob.id===player.pet){let statusIcon='';if(mob.state==='chase_enemy'||mob.state==='attacking_enemy'){statusIcon='⚔️';}else if(mob.state==='foraging'){statusIcon='🍄';}if(mob.customName){ctx.font=`bold ${TILE_SIZE*0.4}px sans-serif`;ctx.fillStyle='#FFFF99';ctx.textAlign='center';ctx.fillText(mob.customName,screenX,screenY-TILE_SIZE*0.9);}if(statusIcon){ctx.font=`${TILE_SIZE*0.6}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(statusIcon,screenX,screenY-TILE_SIZE*0.6);}}});}
    function drawProjectiles(){ctx.strokeStyle='#5D4037';ctx.lineWidth=3;projectiles.forEach(p=>{const screenX=p.x*TILE_SIZE-camera.x;const screenY=p.y*TILE_SIZE-camera.y;ctx.beginPath();ctx.moveTo(screenX,screenY);ctx.lineTo(screenX-p.vx*10,screenY-p.vy*10);ctx.stroke();ctx.closePath();});}
    function toggleCraftingMenu(isWorkbench=false,forceClose=false){if(isGameOver||isPaused)return;const menu=isWorkbench?ui.workbenchMenu:ui.craftingMenu;const shouldOpen=menu.style.display!=='flex';ui.craftingMenu.style.display='none';ui.workbenchMenu.style.display='none';if(forceClose)return;if(shouldOpen){menu.style.display='flex';populateCraftingMenu(isWorkbench);}}
    function populateCraftingMenu(isWorkbench){const listElement=isWorkbench?ui.workbenchRecipesList:ui.recipesList;listElement.innerHTML='';for(const id in RECIPES){const r=RECIPES[id];if((isWorkbench&&!r.requires)||(!isWorkbench&&r.requires))continue;const canCraft=r.cost.every(c=>(inventory.resources[c.item]||0)>=c.count);const d=document.createElement('div');d.className='recipe';let s=r.cost.map(c=>`${ITEM_DEFS[c.item].name}x${c.count}`).join(', ');d.innerHTML=`<strong>${r.name}</strong><p>需要: ${s}</p><button ${canCraft?'':'disabled'} onclick="craftItem('${id}', ${isWorkbench})">合成</button>`;listElement.appendChild(d);}}
    function craftItem(id,isWorkbench){const r=RECIPES[id];if(!r.cost.every(c=>(inventory.resources[c.item]||0)>=c.count))return;r.cost.forEach(c=>{inventory.resources[c.item]-=c.count;if(inventory.resources[c.item]<=0)removeItem(c.item,true);});addItem(r.result.item,r.result.count);showMessage(`合成了 ${r.name}！`);populateCraftingMenu(isWorkbench);updateUI();}
    let selectedInventorySwap=null;
    function toggleFullInventory(){if(isGameOver||isPaused)return;const v=ui.fullInventoryMenu.style.display==='flex';ui.fullInventoryMenu.style.display=v?'none':'flex';if(!v){selectedInventorySwap=null;populateFullInventory();}}
    function populateFullInventory(){ui.fullInventoryHotbar.innerHTML='';ui.fullInventoryBag.innerHTML='';const bagItems=new Set();inventory.items.forEach(item=>bagItems.add(item.id));Object.keys(inventory.resources).forEach(key=>{if(inventory.resources[key]>0){bagItems.add(key);}});for(let i=0;i<HOTBAR_SIZE;i++){const itemId=inventory.hotbar[i];const d=document.createElement('div');d.className='inventory-item hotbar-slot';if(itemId){const itemData=findItemById(itemId);if(itemData){const count=itemData.isResource?inventory.resources[itemId]:undefined;d.innerHTML=renderInventoryItem(itemData,count);bagItems.delete(itemId);}}if(selectedInventorySwap&&selectedInventorySwap.id===itemId){d.classList.add('selected');}d.onclick=()=>onFullInventoryClick(itemId,i,true);ui.fullInventoryHotbar.appendChild(d);}
    bagItems.forEach(itemId=>{const itemData=findItemById(itemId);if(!itemData)return;const d=document.createElement('div');d.className='inventory-item';const count=itemData.isResource?inventory.resources[itemId]:undefined;d.innerHTML=renderInventoryItem(itemData,count);if(selectedInventorySwap&&selectedInventorySwap.id===itemId){d.classList.add('selected');}d.onclick=()=>onFullInventoryClick(itemId,null,false);ui.fullInventoryBag.appendChild(d);});}
    function onFullInventoryClick(itemId,index,isHotbar){if(!selectedInventorySwap){if(itemId){selectedInventorySwap={id:itemId,index:index,isHotbar:isHotbar};showMessage(`已選擇 ${ITEM_DEFS[findItemById(itemId).type].name}`);populateFullInventory();}}else{if(selectedInventorySwap.id===itemId){selectedInventorySwap=null;showMessage("取消選擇");populateFullInventory();return;}
    const source=selectedInventorySwap;const dest={id:itemId,index:index,isHotbar:isHotbar};if(source.isHotbar&&dest.isHotbar){[inventory.hotbar[source.index],inventory.hotbar[dest.index]]=[inventory.hotbar[dest.index],inventory.hotbar[source.index]];}else if(source.isHotbar&&!dest.isHotbar){if(dest.id===null){inventory.hotbar[source.index]=null;}}else if(!source.isHotbar&&dest.isHotbar){const oldItemInDest=inventory.hotbar[dest.index];inventory.hotbar[dest.index]=source.id;}
    selectedInventorySwap=null;populateFullInventory();updateUI();}}
    function generateMerchantTrades(){merchantData.trades=[];const sellPool=[...TRADE_POOL.sell];for(let i=0;i<3;i++){if(sellPool.length>0){const sellIndex=Math.floor(Math.random()*sellPool.length);merchantData.trades.push({...sellPool[sellIndex],type:'sell'});sellPool.splice(sellIndex,1);}}
    TRADE_POOL.buy.forEach(buyTrade=>{merchantData.trades.push({...buyTrade,type:'buy'});});}
    function toggleMerchantMenu(forceOpen=false){if(isGameOver||isPaused)return;const menu=ui.merchantMenu;const shouldOpen=forceOpen||menu.style.display!=='flex';if(shouldOpen){if(merchantData.id===null){showMessage("商人不在這裡。");return;}menu.style.display='flex';populateMerchantMenu();}else{menu.style.display='none';}}
    function populateMerchantMenu(){ui.sellTradesList.innerHTML='';ui.buyTradesList.innerHTML='';merchantData.trades.forEach((trade,index)=>{const d=document.createElement('div');d.className='recipe';let tradeText,canAfford,buttonHTML,unlockDayText='';if(trade.type==='sell'){tradeText=`賣出 ${trade.count} ${ITEM_DEFS[trade.item].name} 換取 ${trade.price} ${ITEM_DEFS.coin.name}`;canAfford=(inventory.resources[trade.item]||0)>=trade.count;buttonHTML=`<button ${canAfford?'':'disabled'} onclick="executeTrade(${index})">交換</button>`;d.innerHTML=`<p>${tradeText}</p>${buttonHTML}`;ui.sellTradesList.appendChild(d);}else{unlockDayText='';let isLocked=false;if(trade.unlockDay&&day<trade.unlockDay){isLocked=true;unlockDayText=` (解鎖D${trade.unlockDay})`;}
    tradeText=`用 ${trade.price} ${ITEM_DEFS.coin.name} 購買 ${trade.count} ${ITEM_DEFS[trade.item].name}${unlockDayText}`;canAfford=(inventory.resources.coin||0)>=trade.price&&!isLocked;let disabledReason=isLocked?`title="需存活至第${trade.unlockDay}天才能解鎖"`:'';buttonHTML=`<button ${canAfford?'':'disabled'} ${disabledReason} onclick="executeTrade(${index})">交換</button>`;d.innerHTML=`<p>${tradeText}</p>${buttonHTML}`;ui.buyTradesList.appendChild(d);}});ui.merchantCoinDisplay.innerHTML=`<p>你擁有: ${inventory.resources.coin||0} ${ITEM_DEFS.coin.name}</p>`;}
    function executeTrade(tradeIndex){const trade=merchantData.trades[tradeIndex];if(!trade)return;if(trade.type==='buy'&&trade.unlockDay&&day<trade.unlockDay){showMessage(`此商品需存活至第${trade.unlockDay}天才能購買！`);return;}
    if(trade.type==='sell'){if((inventory.resources[trade.item]||0)>=trade.count){inventory.resources[trade.item]-=trade.count;addResource('coin',trade.price);showMessage(`交易成功！獲得 ${trade.price} 🪙`);}else{showMessage("你的資源不足！");return;}}else{if((inventory.resources.coin||0)>=trade.price){inventory.resources.coin-=trade.price;addResource(trade.item,trade.count);showMessage(`交易成功！獲得 ${trade.count} ${ITEM_DEFS[trade.item].name}`);}else{showMessage("你的 🪙 不足！");return;}}
    populateMerchantMenu();updateUI();}
    function toggleUpgradeMenu(){if(isGameOver||isPaused)return;const v=ui.upgradeMenu.style.display==='flex';ui.upgradeMenu.style.display=v?'none':'flex';if(!v)populateUpgradeMenu();}
    function populateUpgradeMenu(){ui.playerUpgradeSection.innerHTML=`<h3>玩家升級</h3><p>目前最大生命: ${player.maxHp}</p>`;const playerLevel=player.upgradeLevel||0;if(playerLevel<UPGRADE_LEVELS.player.length){const nextUpgrade=UPGRADE_LEVELS.player[playerLevel];let buttonsHTML='';nextUpgrade.costs.forEach(cost=>{const canAfford=(inventory.resources[cost.item]||0)>=cost.count;buttonsHTML+=`<button ${canAfford?'':'disabled'} onclick="upgradeStat('player','${cost.item}')">用 ${cost.count} ${ITEM_DEFS[cost.item].name}</button>`;});ui.playerUpgradeSection.innerHTML+=`<div class="upgrade-row"><p>下一級: +${nextUpgrade.hp} ❤️</p>${buttonsHTML}</div>`;}else{ui.playerUpgradeSection.innerHTML+=`<div class="upgrade-row"><p>已達最高等級！</p></div>`;}
    const pet=mobs.find(m=>m.id===player.pet);if(pet){ui.petUpgradeSection.style.display='block';ui.upgradeDivider.style.display='block';ui.petUpgradeSection.innerHTML=`<h3>寵物升級</h3><p>目前最大生命: ${pet.maxHp}</p>`;const petLevel=pet.upgradeLevel||0;if(petLevel<UPGRADE_LEVELS.pet.length){const nextUpgrade=UPGRADE_LEVELS.pet[petLevel];let buttonsHTML='';nextUpgrade.costs.forEach(cost=>{const canAfford=(inventory.resources[cost.item]||0)>=cost.count;buttonsHTML+=`<button ${canAfford?'':'disabled'} onclick="upgradeStat('pet','${cost.item}')">用 ${cost.count} ${ITEM_DEFS[cost.item].name}</button>`;});ui.petUpgradeSection.innerHTML+=`<div class="upgrade-row"><p>下一級: +${nextUpgrade.hp} ❤️</p>${buttonsHTML}</div>`;}else{ui.petUpgradeSection.innerHTML+=`<div class="upgrade-row"><p>已達最高等級！</p></div>`;}}else{ui.petUpgradeSection.style.display='none';ui.upgradeDivider.style.display='none';}}
    function upgradeStat(target,resource){if(target==='player'){const level=player.upgradeLevel||0;if(level>=UPGRADE_LEVELS.player.length)return;const upgrade=UPGRADE_LEVELS.player[level];const cost=upgrade.costs.find(c=>c.item===resource);if(cost&&(inventory.resources[cost.item]||0)>=cost.count){inventory.resources[cost.item]-=cost.count;player.maxHp+=upgrade.hp;player.hp+=upgrade.hp;player.upgradeLevel++;showMessage("玩家生命升級！");populateUpgradeMenu();updateUI();}}else if(target==='pet'){const pet=mobs.find(m=>m.id===player.pet);if(!pet)return;const level=pet.upgradeLevel||0;if(level>=UPGRADE_LEVELS.pet.length)return;const upgrade=UPGRADE_LEVELS.pet[level];const cost=upgrade.costs.find(c=>c.item===resource);if(cost&&(inventory.resources[cost.item]||0)>=cost.count){inventory.resources[cost.item]-=cost.count;pet.maxHp+=upgrade.hp;pet.hp+=upgrade.hp;pet.upgradeLevel++;showMessage("寵物生命升級！");populateUpgradeMenu();updateUI();}}}
    function gameOver(){isGameOver=true;if(gameLoopId)cancelAnimationFrame(gameLoopId);gameLoopId=null;ui.gameOverScreen.style.display='flex';ui.survivalDaysText.textContent=`你存活了 ${day} 天。`;if(player.poison.interval)clearInterval(player.poison.interval);}
    function exportSave(){const dataToSave={...{player,inventory,world,gameTime,day,selectedId,mobs,projectiles,saveReminderTimer,merchantData,activeFarms,merchantSpawnSchedule,lastMerchantCycle}};delete dataToSave.player.poison;const data=JSON.stringify(dataToSave);const blob=new Blob([data],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='JungleSurvival_Save.txt';a.click();URL.revokeObjectURL(url);showMessage("存檔已匯出！");}
    function importSave(e){if(gameLoopId)cancelAnimationFrame(gameLoopId);gameLoopId=null;const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{let success=false;const text=e.target.result;try{const importedData=JSON.parse(text);player=importedData.player||player;inventory=importedData.inventory||inventory;world=importedData.world||world;gameTime=importedData.gameTime||gameTime;day=importedData.day||day;selectedId=importedData.selectedId||selectedId;mobs=importedData.mobs||[];projectiles=importedData.projectiles||[];saveReminderTimer=importedData.saveReminderTimer||300000;merchantData=importedData.merchantData||{id:null,trades:[],despawnTime:0};activeFarms=importedData.activeFarms||[];merchantSpawnSchedule=importedData.merchantSpawnSchedule||[];lastMerchantCycle=importedData.lastMerchantCycle!==undefined?importedData.lastMerchantCycle:-1;if(lastMerchantCycle===-1||merchantSpawnSchedule.length===0){checkAndGenerateMerchantSchedule();}
    player.poison={active:false,timer:0,interval:null};player.lastTileId=player.lastTileId||-1;success=true;}catch(err){console.error("檔案解析失敗:",err);showMessage("檔案毀損或格式錯誤！");}finally{isGameOver=false;isPaused=false;ui.gameOverScreen.style.display='none';ui.pauseScreen.style.display='none';ui.craftingMenu.style.display='none';ui.fullInventoryMenu.style.display='none';ui.upgradeMenu.style.display='none';ui.introScreen.style.display='none';if(success){updateUI();showMessage("存檔匯入成功！遊戲已載入。");}
    startGameLoop();}};reader.readAsText(file);}
    window.addEventListener('keydown',e=>{const k=e.key.toLowerCase();keysPressed[k]=true;if(isPaused||isGameOver)return;if(k==='c')toggleCraftingMenu();if(k==='i')toggleFullInventory();});
    window.addEventListener('keyup',e=>{keysPressed[e.key.toLowerCase()]=false;});
    ui.pauseButton.addEventListener('click',togglePause);ui.resumeButton.addEventListener('click',togglePause);ui.pauseCloseButton.addEventListener('click',togglePause);
    ui.resetButton.addEventListener('click',resetGame);ui.restartButton.addEventListener('click',()=>{isIntentionallyReloading=true;window.location.reload();});
    populateMapLegend=function(){ui.mapLegendList.innerHTML='';const legendCanvas=document.createElement('canvas');legendCanvas.width=legendCanvas.height=TILE_SIZE;const legendCtx=legendCanvas.getContext('2d');for(const key in TILE_TYPES){const tile=TILE_TYPES[key];legendCtx.clearRect(0,0,TILE_SIZE,TILE_SIZE);const dummyDraw=(tile,x,y,wx,wy)=>{const rand=()=>0.5;switch(tile.id){case 1:case 4:case 5:case 9:case 10:case 11:case 13:case 14:case 15:case 17:case 18:legendCtx.fillStyle='#4CAF50';legendCtx.fillRect(x,y,32,32);break;default:break;}switch(tile.id){case 0:legendCtx.fillStyle='#4CAF50';legendCtx.fillRect(x,y,32,32);for(let i=0;i<3;i++){legendCtx.fillStyle='rgba(0,0,0,0.1)';legendCtx.beginPath();legendCtx.arc(x+rand()*32+i*5,y+rand()*32,1,0,2*Math.PI);legendCtx.fill();legendCtx.closePath();}break;case 1:legendCtx.font='28px sans-serif';legendCtx.textAlign='center';legendCtx.fillText(tile.name,x+16,y+16);break;case 3:legendCtx.fillStyle='#757575';legendCtx.fillRect(x,y,32,32);legendCtx.strokeStyle='#424242';legendCtx.lineWidth=1;legendCtx.beginPath();legendCtx.moveTo(x+5,y+5);legendCtx.lineTo(x+22,y+27);legendCtx.stroke();legendCtx.closePath();break;case 2:legendCtx.fillStyle='#1976D2';legendCtx.fillRect(x,y,32,32);break;case 6:legendCtx.fillStyle='#64B5F6';legendCtx.fillRect(x,y,32,32);break;case 4:legendCtx.fillStyle='#C2185B';for(let i=0;i<3;i++){legendCtx.beginPath();legendCtx.arc(x+10+i*6,y+16,3,0,2*Math.PI);legendCtx.fill();legendCtx.closePath();}break;case 5:legendCtx.fillStyle=tile.unlit_color;legendCtx.beginPath();legendCtx.arc(x+16,y+16,10,0,2*Math.PI);legendCtx.fill();legendCtx.closePath();break;case 9:legendCtx.fillStyle='#8D6E63';legendCtx.fillRect(x,y,32,32);legendCtx.fillStyle='#5D4037';for(let i=0;i<32;i+=8){legendCtx.fillRect(x,y+i,32,1);}break;case 10:legendCtx.fillStyle='#78909C';legendCtx.fillRect(x,y,32,32);legendCtx.strokeStyle='#455A64';for(let i=0;i<2;i++){for(let j=0;j<2;j++){legendCtx.strokeRect(x+j*16,y+i*16,16,16);}}break;case 11:legendCtx.fillStyle=tile.color;legendCtx.fillRect(x,y,32,32);legendCtx.fillStyle='#5D4037';legendCtx.fillRect(x,y+7,32,2);legendCtx.fillRect(x,y+23,32,2);legendCtx.fillStyle='#E0E0E0';legendCtx.fillRect(x+24,y+14,4,4);break;case 12:legendCtx.fillStyle='#757575';legendCtx.fillRect(x,y,32,32);for(let i=0;i<3;i++){legendCtx.fillStyle=`rgba(213,99,44,0.6)`;legendCtx.beginPath();legendCtx.arc(x+16+(rand()-0.5)*20,y+16+(rand()-0.5)*20,rand()*4+2,0,2*Math.PI);legendCtx.fill();legendCtx.closePath();}break;case 13:legendCtx.fillStyle=tile.color;legendCtx.fillRect(x+4,y+8,24,20);legendCtx.fillStyle='#6d4c41';legendCtx.fillRect(x+4,y+8,4,20);legendCtx.fillRect(x+24,y+8,4,20);legendCtx.fillRect(x+4,y+24,24,4);break;case 14:legendCtx.fillStyle=tile.color;legendCtx.fillRect(x,y,32,32);legendCtx.strokeStyle='#607D8B';legendCtx.lineWidth=2;for(let i=0;i<=32;i+=8){legendCtx.beginPath();legendCtx.moveTo(x+i,y);legendCtx.lineTo(x+i,y+32);legendCtx.stroke();legendCtx.closePath();legendCtx.beginPath();legendCtx.moveTo(x,y+i);legendCtx.lineTo(x+32,y+i);legendCtx.stroke();legendCtx.closePath();}break;case 15:legendCtx.fillStyle=tile.color;legendCtx.fillRect(x,y,32,32);legendCtx.fillStyle='#546E7A';legendCtx.fillRect(x+4,y+4,24,24);legendCtx.fillStyle='#CFD8DC';legendCtx.fillRect(x+14,y+14,4,4);break;case 16:legendCtx.fillStyle=tile.color;legendCtx.fillRect(x,y,32,32);legendCtx.strokeStyle='#8D8D8D';legendCtx.lineWidth=1;legendCtx.strokeRect(x,y,32,32);legendCtx.beginPath();legendCtx.moveTo(x+16,y);legendCtx.lineTo(x+16,y+32);legendCtx.stroke();legendCtx.closePath();legendCtx.beginPath();legendCtx.moveTo(x,y+16);legendCtx.lineTo(x+32,y+16);legendCtx.stroke();legendCtx.closePath();break;case 17:legendCtx.font='28px sans-serif';legendCtx.textAlign='center';legendCtx.fillText(tile.name,x+16,y+16);break;case 18:legendCtx.fillStyle=tile.color;legendCtx.fillRect(x,y,32,32);legendCtx.fillStyle='rgba(0,0,0,0.5)';for(let i=0;i<2;i++){legendCtx.beginPath();legendCtx.arc(x+rand()*32,y+rand()*32,1,0,2*Math.PI);legendCtx.fill();legendCtx.closePath();}break;default:legendCtx.fillStyle='#9C27B0';legendCtx.fillRect(x,y,32,32);break;}};dummyDraw(tile,0,0,0,0);const imgData=legendCanvas.toDataURL();let legendName=tile.name;if(key==='MUSHROOM')legendName='蘑菇';ui.mapLegendList.innerHTML+=`<li><div class="legend-icon" style="background-image: url(${imgData})"></div><span>${legendName}</span></li>`;}}
    draw=function(dt){ctx.clearRect(0,0,canvas.width,canvas.height);const sX=Math.floor(camera.x/TILE_SIZE),sY=Math.floor(camera.y/TILE_SIZE),eX=sX+Math.ceil(canvas.width/TILE_SIZE),eY=sY+Math.ceil(canvas.height/TILE_SIZE);for(let y=sY;y<=eY;y++){for(let x=sX;x<=eX;x++){drawTileDetail(getTile(x,y),x*TILE_SIZE-camera.x,y*TILE_SIZE-camera.y,x,y);}}
    drawProjectiles();drawMobs();if(player.action.type!=='none'){const pScreenX=player.x*TILE_SIZE-camera.x;const pScreenY=player.y*TILE_SIZE-camera.y;const barY=pScreenY-TILE_SIZE*0.9;ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(pScreenX-25,barY,50,8);ctx.fillStyle='#FFC107';ctx.fillRect(pScreenX-25,barY,50*(player.action.timer/player.action.duration),8);}
    if(playerImage.complete){const pScreenX=player.x*TILE_SIZE-camera.x;const pScreenY=player.y*TILE_SIZE-camera.y;const sourceX=pAnimFrame*PLAYER_SPRITE_WIDTH;ctx.drawImage(playerImage,sourceX,0,PLAYER_SPRITE_WIDTH,PLAYER_SPRITE_HEIGHT,pScreenX-PLAYER_DRAW_WIDTH/2,pScreenY-PLAYER_DRAW_HEIGHT/2,PLAYER_DRAW_WIDTH,PLAYER_DRAW_HEIGHT);}else{ctx.fillStyle='#FFEB3B';ctx.beginPath();ctx.arc(player.x*TILE_SIZE-camera.x,player.y*TILE_SIZE-camera.y,TILE_SIZE/2.5,0,2*Math.PI);ctx.fill();}
    const l=getLightLevel(sX,sY,eX,eY);if(l<1){ctx.fillStyle=`rgba(0,0,25,${1-l})`;ctx.fillRect(0,0,canvas.width,canvas.height);}}
    drawTileDetail=function(tile,screenX,screenY,worldX,worldY){ctx.save();const dRand=s=>()=>{let t=s+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;};const rand=dRand((worldX*18395679)^(worldY*37586093));ctx.font=`${TILE_SIZE*0.9}px sans-serif`;ctx.textAlign='center';ctx.textBaseline='middle';switch(tile.id){case 1:case 4:case 5:case 9:case 10:case 11:case 13:case 14:case 15:case 17:case 18:ctx.fillStyle='#4CAF50';ctx.fillRect(screenX,screenY,32,32);break;default:break;}
    switch(tile.id){case 0:ctx.fillStyle='#4CAF50';ctx.fillRect(screenX,screenY,32,32);for(let i=0;i<3;i++){ctx.fillStyle='rgba(0,0,0,0.1)';ctx.beginPath();ctx.arc(screenX+rand()*32,screenY+rand()*32,1,0,2*Math.PI);ctx.fill();ctx.closePath();}break;case 1:ctx.fillText(tile.name,screenX+16,screenY+16);break;case 3:ctx.fillStyle='#757575';ctx.fillRect(screenX,screenY,32,32);ctx.strokeStyle='#424242';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(screenX+rand()*10+5,screenY+rand()*10+5);ctx.lineTo(screenX+32-rand()*10-5,screenY+32-rand()*10-5);ctx.stroke();ctx.closePath();break;case 2:ctx.fillStyle='#1976D2';ctx.fillRect(screenX,screenY,32,32);for(let i=0;i<2;i++){ctx.fillStyle='rgba(255,255,255,0.2)';ctx.beginPath();ctx.arc(screenX+rand()*32,screenY+rand()*32,2,0,2*Math.PI);ctx.fill();ctx.closePath();}break;case 6:ctx.fillStyle='#64B5F6';ctx.fillRect(screenX,screenY,32,32);break;case 4:ctx.fillStyle='#C2185B';for(let i=0;i<5;i++){ctx.beginPath();ctx.arc(screenX+16+(rand()-0.5)*20,screenY+16+(rand()-0.5)*20,3,0,2*Math.PI);ctx.fill();ctx.closePath();}break;case 5:ctx.fillStyle=tile.isLit?tile.lit_color:tile.unlit_color;ctx.beginPath();ctx.arc(screenX+16,screenY+16,10.6,0,2*Math.PI);ctx.fill();ctx.closePath();if(tile.isLit&&tile.fuel>0){const barY=screenY+27;ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(screenX,barY,32,5);ctx.fillStyle='#FFC107';ctx.fillRect(screenX,barY,32*(tile.fuel/tile.maxFuel),5);}break;case 9:ctx.fillStyle='#8D6E63';ctx.fillRect(screenX,screenY,32,32);ctx.fillStyle='#5D4037';for(let i=0;i<32;i+=8){ctx.fillRect(screenX,screenY+i,32,1);}break;case 10:ctx.fillStyle='#78909C';ctx.fillRect(screenX,screenY,32,32);ctx.strokeStyle='#455A64';for(let i=0;i<2;i++){for(let j=0;j<2;j++){ctx.strokeRect(screenX+j*16,screenY+i*16,16,16);}}break;case 11:ctx.fillStyle=tile.color;if(tile.isOpen){ctx.fillRect(screenX,screenY,6,32);ctx.fillRect(screenX+26,screenY,6,32);}else{ctx.fillRect(screenX,screenY,32,32);ctx.fillStyle='#5D4037';ctx.fillRect(screenX,screenY+7,32,2);ctx.fillRect(screenX,screenY+23,32,2);ctx.fillStyle='#E0E0E0';ctx.fillRect(screenX+24,screenY+14,4,4);}break;case 12:ctx.fillStyle='#757575';ctx.fillRect(screenX,screenY,32,32);for(let i=0;i<3;i++){ctx.fillStyle=`rgba(213,99,44,${0.4+rand()*0.4})`;ctx.beginPath();ctx.arc(screenX+16+(rand()-0.5)*20,screenY+16+(rand()-0.5)*20,rand()*4+2,0,2*Math.PI);ctx.fill();ctx.closePath();}break;case 13:ctx.fillStyle=tile.color;ctx.fillRect(screenX+4,screenY+8,24,20);ctx.fillStyle='#6d4c41';ctx.fillRect(screenX+4,screenY+8,4,20);ctx.fillRect(screenX+24,screenY+8,4,20);ctx.fillRect(screenX+4,screenY+24,24,4);ctx.font=`${TILE_SIZE*0.7}px sans-serif`;ctx.fillText('⚒️',screenX+16,screenY+16);break;case 14:ctx.fillStyle=tile.color;ctx.fillRect(screenX,screenY,32,32);ctx.strokeStyle='#607D8B';ctx.lineWidth=2;for(let i=0;i<32;i+=8){ctx.beginPath();ctx.moveTo(screenX+i,screenY);ctx.lineTo(screenX+i,screenY+32);ctx.stroke();ctx.closePath();ctx.beginPath();ctx.moveTo(screenX,screenY+i);ctx.lineTo(screenX+32,screenY+i);ctx.stroke();ctx.closePath();}break;case 15:ctx.fillStyle=tile.color;if(tile.isOpen){ctx.fillRect(screenX,screenY,6,32);ctx.fillRect(screenX+26,screenY,6,32);}else{ctx.fillRect(screenX,screenY,32,32);ctx.fillStyle='#546E7A';ctx.fillRect(screenX+4,screenY+4,24,24);ctx.fillStyle='#CFD8DC';ctx.fillRect(screenX+14,screenY+14,4,4);}break;case 16:ctx.fillStyle=tile.color;ctx.fillRect(screenX,screenY,32,32);ctx.strokeStyle='#8D8D8D';ctx.lineWidth=1;ctx.strokeRect(screenX,screenY,32,32);ctx.beginPath();ctx.moveTo(screenX+16,screenY);ctx.lineTo(screenX+16,screenY+32);ctx.stroke();ctx.closePath();ctx.beginPath();ctx.moveTo(screenX,screenY+16);ctx.lineTo(screenX+32,screenY+16);ctx.stroke();ctx.closePath();break;case 17:ctx.fillText('🛏️',screenX+16,screenY+16);break;case 18:ctx.fillStyle=tile.color;ctx.fillRect(screenX,screenY,32,32);ctx.fillStyle='rgba(0,0,0,0.5)';for(let i=0;i<4;i++){ctx.beginPath();ctx.arc(screenX+rand()*32,screenY+rand()*32,1,0,2*Math.PI);ctx.fill();}if(tile.state==='growing'){ctx.font=`${TILE_SIZE*0.5}px sans-serif`;ctx.fillText('🌱',screenX+16,screenY+16);}else if(tile.state==='mature'){ctx.font=`${TILE_SIZE*0.9}px sans-serif`;ctx.fillText(ITEM_DEFS[tile.crop].name,screenX+16,screenY+16);}break;default:ctx.fillStyle='#9C27B0';ctx.fillRect(screenX,screenY,32,32);break;}
    if(tile.feature==='mushroom'){ctx.globalAlpha=0.9;ctx.font=`${TILE_SIZE*0.7}px sans-serif`;ctx.fillText('🍄',screenX+16+(rand()-0.5)*10,screenY+16+(rand()-0.5)*10);}
    else if(tile.groundItem==='stick'){ctx.fillStyle='#A1887F';ctx.fillRect(screenX+6.4,screenY+16,19.2,4);}
    else if(tile.groundItem==='flint'){ctx.fillStyle='#B0BEC5';ctx.beginPath();ctx.moveTo(screenX+10,screenY+22);ctx.lineTo(screenX+22,screenY+22);ctx.lineTo(screenX+16,screenY+10);ctx.closePath();ctx.fill();}
    if(tile.isBurning){ctx.font=`${TILE_SIZE*0.7}px sans-serif`;ctx.fillText('🔥',screenX+16,screenY+10);}ctx.restore();}
    getLightLevel=function(sX,sY,eX,eY){const h=gameTime/60;const NIGHT_BRIGHTNESS=0.15,DAY_BRIGHTNESS=1.0,CAMPFIRE_BRIGHTNESS=0.85;let timeBrightness;if(h>6&&h<18)timeBrightness=DAY_BRIGHTNESS;else if(h>=18&&h<20)timeBrightness=DAY_BRIGHTNESS-(h-18)/2*(DAY_BRIGHTNESS-NIGHT_BRIGHTNESS);else if(h>=4&&h<6)timeBrightness=NIGHT_BRIGHTNESS+(h-4)/2*(DAY_BRIGHTNESS-NIGHT_BRIGHTNESS);else timeBrightness=NIGHT_BRIGHTNESS;let finalBrightness=timeBrightness;for(let y=sY;y<=eY;y++){for(let x=sX;x<=eX;x++){const tile=getTile(x,y);if(tile&&tile.isLit){finalBrightness=Math.max(finalBrightness,CAMPFIRE_BRIGHTNESS);}}}return finalBrightness;}
</script>
</body>
</html>